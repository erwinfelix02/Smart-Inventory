<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Inventory</title>
  <link rel="stylesheet" href="email.css">
  <link rel="icon" type="image/png" href="../images/logo.svg">
</head>
<body>
  <div class="container">
    <!-- Left Side Image -->
    <div class="image-side"></div>

    <!-- Right Side Form -->
    <div class="form-side">
      <div class="form-box">
        <h2>Check your email</h2>
       <p id="emailMessage">
           We’ve sent you a passcode.<br>
           Please check your inbox at <span id="userEmail"></span>
       </p>


        <!-- Code Input Boxes -->
        <div class="code-inputs">
          <input type="text" maxlength="1">
          <input type="text" maxlength="1">
          <input type="text" maxlength="1">
          <input type="text" maxlength="1">
          <input type="text" maxlength="1">
          <input type="text" maxlength="1">
        </div>

        <a href="#" class="resend">Resend code</a>

        <!-- Continue Button -->
        <button class="btn">Continue</button>
      </div>
    </div>
  </div>
<script>


const inputs = document.querySelectorAll(".code-inputs input");
const continueBtn = document.querySelector(".btn");
const resendBtn = document.querySelector(".resend");

// Get email from query string
const params = new URLSearchParams(window.location.search);
const email = params.get("email");
const source = params.get("source"); // either "login" or "forgot"
const role = params.get("role");

if (email) document.getElementById("userEmail").textContent = email;

// Show the full email in the message
const emailMessage = document.getElementById("userEmail");
if (email) emailMessage.textContent = email;

// Create a loading overlay
function showLoading() {
  const loading = document.createElement("div");
  loading.classList.add("loading-overlay", "active");
  loading.innerHTML = '<div class="spinner"></div>';
  document.body.appendChild(loading);
  return loading;
}

function hideLoading(loading) {
  if (loading) {
    loading.classList.remove("active");
    setTimeout(() => loading.remove(), 300);
  }
}

// Reset input error state
function resetInputError() {
  inputs.forEach(input => input.classList.remove("input-error"));
}

// Add red effect with slight delay
function showInputError(delay = 500) {
  setTimeout(() => {
    inputs.forEach(input => input.classList.add("input-error"));
  }, delay);
}

// Auto move between inputs and clear errors
inputs.forEach((input, index) => {
  input.addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, ""); // digits only
    if (e.target.value && index < inputs.length - 1) inputs[index + 1].focus();
    resetInputError();
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && !input.value && index > 0) inputs[index - 1].focus();
    if (e.key === " ") e.preventDefault(); // block space
  });
});

// Handle verification button click
continueBtn.addEventListener("click", async () => {
  const code = Array.from(inputs).map(input => input.value).join("");
  if (code.length !== 6) {
    const loading = showLoading();
    setTimeout(() => {
      hideLoading(loading);
      showInputError();
    }, 800);
    return;
  }

  resetInputError();
  const loading = showLoading();

  try {
    const response = await fetch("http://127.0.0.1:3000/auth/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, code })
    });

    const data = await response.json();

    setTimeout(() => {
      hideLoading(loading);

      if (response.ok) {
        const verifiedUser = {
          email: data.user.email,
          fullName: data.user.fullName || "Unknown",
          role: data.user.role || "Unknown"
        };
        localStorage.setItem("user", JSON.stringify(verifiedUser));

         // Set flag to show welcome overlay
    localStorage.setItem("showWelcome", "true")
    
        const msg = document.createElement("p");
        msg.style.color = "green";
        msg.textContent = "Verification successful! Redirecting...";
        document.body.appendChild(msg);

       setTimeout(() => {
        if (source === "forgot") {
          // ✅ Redirect to reset-password page and include the email in the URL
          window.location.href = `../Contents/reset-password.html?email=${encodeURIComponent(email)}`;
        } else {
          // ✅ If from login/signup → go to dashboard
          window.location.href = "../Contents/Sidebar.html";
        }

      }, 1000);


      } else {
        const msg = document.createElement("p");
        msg.style.color = "red";
        msg.textContent = data.msg || "Invalid code. Please try again.";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);

        showInputError(300);
      }
    }, 500);

  } catch (err) {
    console.error(err);
    setTimeout(() => {
      hideLoading(loading);
      showInputError(300);

      const msg = document.createElement("p");
      msg.style.color = "red";
      msg.textContent = "Server error. Please try again.";
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }, 500);
  }
});

// Resend code with cooldown, messages, and input error
let resendCooldown = 30; // seconds
let resendInterval;

resendBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  if (resendBtn.disabled) return;

  // Start cooldown
  resendBtn.disabled = true;
  let timeLeft = resendCooldown;
  resendBtn.textContent = `Resend code (${timeLeft}s)`;

  resendInterval = setInterval(() => {
    timeLeft--;
    resendBtn.textContent = `Resend code (${timeLeft}s)`;
    if (timeLeft <= 0) {
      clearInterval(resendInterval);
      resendBtn.disabled = false;
      resendBtn.textContent = "Resend code";
    }
  }, 1000);

  // Show loading overlay
  const loading = showLoading();

  try {
    const response = await fetch("http://127.0.0.1:3000/auth/resend-code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await response.json();
    setTimeout(() => hideLoading(loading), 500);

    if (response.ok) {
      // ✅ Success message
      const msg = document.createElement("p");
      msg.style.color = "green";
      msg.textContent = `A new verification code has been sent to ${email}.`;
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);

      console.log("Verification code resent successfully.");
      resetInputError(); // clear red inputs if any
    } else {
      // ❌ Failure message
      const msg = document.createElement("p");
      msg.style.color = "red";
      msg.textContent = data.msg || "Failed to resend code. Please try again.";
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);

      console.error("Failed to resend code:", data);
      showInputError(300);
    }
  } catch (err) {
    console.error(err);
    setTimeout(() => {
      hideLoading(loading);

      const msg = document.createElement("p");
      msg.style.color = "red";
      msg.textContent = "Server error. Could not resend code.";
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);

      showInputError(300);
    }, 500);
  }
});
localStorage.setItem("userRole", user.role);



</script>


</body>
</html>
