<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Page</title>
  <link rel="stylesheet" href="signin.css">
  <!-- Icons (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Left side image -->
    <div class="image-side"></div>

    <!-- Right side login form -->
    <div class="form-side">
      <div class="signin">
        <h2>Sign In</h2>
        <p class="subtitle">Sign in to Your Registered Account</p>

        <form id="loginForm">
          <!-- Email -->
          <div class="input-group">
            <i class="fa-solid fa-envelope"></i>
            <input type="email" id="email" placeholder="Enter your email" required>
          </div>

          <!-- Password -->
          <div class="input-group">
            <i class="fa-solid fa-lock"></i>
            <input type="password" id="password" placeholder="Enter your password" required>
            <i class="fa-solid fa-eye-slash toggle-password" id="togglePassword"></i>
          </div>
          <a href="../Contents/forgot-password.html" class="forgot">Forgot Password?</a>
          <button type="submit" class="btn">Sign in</button>
        </form>
      </div>
    </div>
  </div>

<script>
const togglePassword = document.getElementById("togglePassword");
const passwordInput = document.getElementById("password");
const emailInput = document.getElementById("email");
const loginForm = document.getElementById("loginForm");

// ðŸ”’ Toggle password visibility
togglePassword.addEventListener("click", () => {
  const isPassword = passwordInput.type === "password";
  passwordInput.type = isPassword ? "text" : "password";
  togglePassword.classList.toggle("fa-eye");
  togglePassword.classList.toggle("fa-eye-slash");
});

// ðŸ§© Create error text element under email input if it doesn't exist
let emailError = emailInput.parentNode.querySelector('.error-text');
if (!emailError) {
  emailError = document.createElement("div");
  emailError.classList.add("error-text");
  emailInput.parentNode.insertAdjacentElement("afterend", emailError);
}

// Function to show loading spinner
function showLoading() {
  const loading = document.createElement("div");
  loading.classList.add("loading-overlay", "active"); 
  loading.innerHTML = '<div class="spinner"></div>';
  document.body.appendChild(loading);
  return loading;
}

// Function to hide loading spinner
function hideLoading(loading) {
  if (loading) {
    loading.classList.remove("active");
    setTimeout(() => loading.remove(), 300);
  }
}

// Reset error states
function resetErrors() {
  [emailInput, passwordInput].forEach(input => input.classList.remove("input-error"));
  emailError.textContent = "";
}

// âœ… Email validation pattern (gmail.com or phinmaed.com)
const emailPattern = /^[a-zA-Z0-9._%+-]+@(gmail\.com|phinmaed\.com)$/;

// ðŸ–Š Show error on blur if email is invalid
emailInput.addEventListener("blur", () => {
  const value = emailInput.value.trim();
  if (value && !emailPattern.test(value)) {
    emailInput.classList.add("input-error");
    emailError.textContent = "Please enter a valid email (e.g. example@gmail.com or example@phinmaed.com)";
  }
});

// ðŸ“ Handle login form submit
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  resetErrors();

  // âŒ Show error if email invalid after submit
  if (!emailPattern.test(email)) {
    emailInput.classList.add("input-error");
    emailError.textContent = "Please enter a valid email (e.g. example@gmail.com or example@phinmaed.com)";
    return;
  }

  if (!password) {
    passwordInput.classList.add("input-error");
    emailError.textContent = "Please enter your password.";
    return;
  }

  const loading = showLoading();

  try {
    const response = await fetch("http://127.0.0.1:3000/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();

    setTimeout(() => {
      hideLoading(loading);

      if (response.ok) {
        window.location.href = `email.html?email=${encodeURIComponent(email)}&role=${encodeURIComponent(data.role)}`;
      } else {
        emailInput.classList.add("input-error");
        passwordInput.classList.add("input-error");
        emailError.textContent = "Incorrect email or password.";
      }
    }, 800);

  } catch (err) {
    console.error(err);
    setTimeout(() => {
      hideLoading(loading);
      emailInput.classList.add("input-error");
      passwordInput.classList.add("input-error");
      emailError.textContent = "Server error. Please try again.";
    }, 800);
  }
});

// âœï¸ Remove error state when typing again
const inputs = document.querySelectorAll('.input-group input, #email, #password');
inputs.forEach(input => {
  input.addEventListener('input', () => {
    input.classList.remove('input-error');

    const parentGroup = input.closest('.input-group');
    if (parentGroup?.classList.contains('error')) parentGroup.classList.remove('error');

    const errorText = parentGroup?.querySelector('.error-message, .error-text');
    if (errorText) errorText.textContent = '';
  });
});

</script>



</body>
</html>
