<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Overview</title>
  <link rel="stylesheet" href="staff-dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <div class="dashboard">

    <!-- ===== TOP SECTION ===== -->
    <div class="top-section">
      <div class="cards">
        <div class="card">
          <div class="card-content">
            <h4>Today's Sales</h4>
            <p class="amount">₱45,280</p>
            <p class="change">▲ +18% vs yesterday</p>
          </div>
          <div class="icon"><i class="fa-solid fa-chart-line"></i></div>
        </div>

        <div class="card">
          <div class="card-content">
            <h4>Orders Completed</h4>
            <p class="count">127</p>
            <p class="change red">3 more than yesterday</p>
          </div>
          <div class="icon"><i class="fa-solid fa-clipboard-check"></i></div>
        </div>

        <div class="card">
          <div class="card-content">
            <h4>Pending Approvals</h4>
            <p class="count">7</p>
            <p class="change orange">Requires attention</p>
          </div>
          <div class="icon"><i class="fa-regular fa-clock"></i></div>
        </div>
      </div>

      <div class="transactions">
        <div class="header">
          <h4>Recent Transactions</h4>
          <a href="#">View All</a>
        </div>

        <table>
          <thead>
            <tr>
              <th>TRANS ID</th>
              <th>CUSTOMER</th>
              <th>ITEMS</th>
              <th>TOTAL</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>#TXN-001</td>
              <td>Sarah Johnson</td>
              <td>3</td>
              <td>$450.00</td>
              <td><span class="status completed">Completed</span></td>
            </tr>        
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== SALES TREND ===== -->
    <div class="sales-trend">
      <h4>Sales Trend</h4>
      <div class="chart-placeholder">
       <canvas id="salesChart"></canvas>
      </div>
    </div>

  </div>
<!-- ===== TRANSACTIONS MODAL ===== -->
<div id="transactionsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>All Transactions</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <table class="modal-table">
        <thead>
          <tr>
            <th>TRANS ID</th>
            <th>CUSTOMER</th>
            <th>ITEMS</th>
            <th>TOTAL</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody id="modalTransactionsBody">
          <!-- JS populates rows -->
        </tbody>
      </table>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadDashboard() {
  try {
    const txnRes = await fetch("/transactions");
    const transactions = await txnRes.json();

    const tbody = document.querySelector(".transactions tbody");
    tbody.innerHTML = "";

    let pendingCount = 0;
    let completedCount = 0;
    let todaySales = 0;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    let yesterdaySales = 0;
    let yesterdayCompleted = 0;

    // Aggregate daily sales
    const dailySalesMap = {}; // { 'YYYY-MM-DD': total }

    transactions.forEach(txn => {
      const txnStatus = txn.status.toLowerCase();
      const txnDate = new Date(txn.date);
      const dateKey = txnDate.toISOString().split('T')[0]; // YYYY-MM-DD

      // Count pending and completed
      if (txnStatus === "pending") pendingCount++;
      if (txnStatus === "completed") completedCount++;

      // Today's sales
      if (txnStatus === "completed" && txnDate >= today) todaySales += txn.total;

      // Yesterday's sales
      if (txnStatus === "completed" && txnDate >= yesterday && txnDate < today) {
        yesterdaySales += txn.total;
        yesterdayCompleted++;
      }

      // Aggregate daily sales
      if (txnStatus === "completed") {
        dailySalesMap[dateKey] = (dailySalesMap[dateKey] || 0) + txn.total;
      }

      // Populate table row
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>#${txn._id.slice(-6).toUpperCase()}</td>
        <td>${txn.customerName}</td>
        <td>${txn.quantity}</td>
        <td>₱${txn.total.toFixed(2)}</td>
        <td><span class="status ${txnStatus}">${txn.status}</span></td>
      `;
      tbody.appendChild(row);
    });

    // Update cards
    document.querySelector(".cards .card:nth-child(1) .amount").textContent = `₱${todaySales.toFixed(2)}`;
    document.querySelector(".cards .card:nth-child(2) .count").textContent = completedCount;
    document.querySelector(".cards .card:nth-child(3) .count").textContent = pendingCount;

    // Update change texts
    const salesChangeEl = document.querySelector(".cards .card:nth-child(1) .change");
    let salesChange = todaySales - yesterdaySales;
    let salesPercent = yesterdaySales > 0 ? (salesChange / yesterdaySales) * 100 : 100;
    salesChangeEl.textContent = salesChange >= 0 
      ? `▲ +${salesPercent.toFixed(1)}% vs yesterday`
      : `▼ ${Math.abs(salesPercent).toFixed(1)}% vs yesterday`;

    const completedDiff = completedCount - yesterdayCompleted;
    const completedChangeEl = document.querySelector(".cards .card:nth-child(2) .change");
    completedChangeEl.textContent = completedDiff >= 0 
      ? `${completedDiff} more than yesterday` 
      : `${Math.abs(completedDiff)} less than yesterday`;

    const pendingChangeEl = document.querySelector(".cards .card:nth-child(3) .change");
    pendingChangeEl.textContent = pendingCount > 0 
      ? "Requires attention" 
      : "No pending approvals";

    // ------------------------------
    // Prepare Chart.js line chart (chronological)
    // ------------------------------
    const chartLabels = Object.keys(dailySalesMap)
      .sort((a, b) => new Date(a) - new Date(b)); // sort dates chronologically
    const chartData = chartLabels.map(date => dailySalesMap[date]);

    const ctx = document.getElementById("salesChart").getContext("2d");

    // Destroy previous chart if exists
    if (window.salesChartInstance) window.salesChartInstance.destroy();
    // Animation offset
let offset = 0;

// Function to create moving gradient
function getGradient() {
  const width = ctx.canvas.width;
  const gradient = ctx.createLinearGradient(0, 0, width, 0);

  const phase = (offset % 100) / 100; 

  gradient.addColorStop((0 + phase) % 1, 'rgba(0,123,255,1)');
  gradient.addColorStop((0.25 + phase) % 1, 'rgba(0,200,255,1)');
  gradient.addColorStop((0.5 + phase) % 1, 'rgba(0,123,255,1)');
  gradient.addColorStop((0.75 + phase) % 1, 'rgba(0,200,255,1)');
  gradient.addColorStop((1 + phase) % 1, 'rgba(0,123,255,1)');

  return gradient;
}

    window.salesChartInstance = new Chart(ctx, {
  type: "line",
  data: {
    labels: chartLabels,
    datasets: [{
      label: "Daily Sales",
      data: chartData,
      borderColor: "#2563eb",
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
      borderWidth: 6
    }]
  },
  options: {
    responsive: true,
    layout: {
      padding: {
        top: 50,
        right: 20,
        bottom: 60, // extra space for total sales label
        left: 20
      }
    },
    plugins: {
      legend: { display: true, position: "bottom" },
      tooltip: {
        mode: "index",
        intersect: false,
        callbacks: {
          label: function(context) {
            const value = context.raw;
            return `₱${value.toFixed(2)}`;
          }
        }
      },
      
      // Custom plugin to display todaySales below the chart
      afterDraw: chart => {
        const { ctx, chartArea: { bottom, left, right } } = chart;
        ctx.save();
        ctx.font = "bold 14px Inter";
        ctx.fillStyle = "#111827";
        ctx.textAlign = "center";
        const centerX = (left + right) / 2;
        ctx.fillText(`Total Today: ₱${todaySales.toFixed(2)}`, centerX, bottom + 25);
        ctx.restore();
      }
    },
   scales: {
  x: {
    ticks: {
      callback: function(value, index) {
        const date = new Date(this.getLabelForValue(index));
        return date.toLocaleString('default', { month: 'short', day: 'numeric' });
      }
    }
  },
  y: { 
    title: { display: true, text: "Sales (₱)" }, 
    beginAtZero: true 
  }
},
     animation: false
  }
});
// Animate gradient
function animateGradient() {
  offset += 1; // adjust speed here
  window.salesChartInstance.data.datasets[0].borderColor = getGradient();
  window.salesChartInstance.update('none'); // update without anim
  requestAnimationFrame(animateGradient);
}
animateGradient();

  } catch (err) {
    console.error("Error loading dashboard:", err);
  }
}

// Load dashboard
window.addEventListener("DOMContentLoaded", loadDashboard);




// Modal functionality
const modal = document.getElementById("transactionsModal");
const modalBody = document.getElementById("modalTransactionsBody");
const viewAllBtn = document.querySelector(".transactions .header a");
const closeBtn = document.querySelector(".modal .close");

// Open modal and populate table
viewAllBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  try {
    const res = await fetch("/transactions");
    const transactions = await res.json();

    modalBody.innerHTML = ""; // clear previous rows

   transactions.forEach(txn => {
  const txnStatus = txn.status.toLowerCase();

  // Determine singular/plural for items
  const itemsText = txn.quantity === 1 ? "item" : "items";

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>#${txn._id.slice(-6).toUpperCase()}</td>
    <td>${txn.customerName}</td>
    <td>${txn.quantity} ${itemsText}</td>
    <td>₱${txn.total.toFixed(2)}</td>
    <td><span class="status ${txnStatus}">${txn.status}</span></td>
  `;
  modalBody.appendChild(row);
});

    modal.style.display = "block"; // show modal
  } catch (err) {
    console.error("Error loading all transactions:", err);
  }
});

// Close modal
closeBtn.addEventListener("click", () => modal.style.display = "none");
window.addEventListener("click", e => { if(e.target === modal) modal.style.display = "none"; });

</script>



</body>
</html>
