<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Settings</title>
  <!-- Link external CSS -->
  <link rel="stylesheet" href="profile-settings.css">
  <!-- for eye icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
  <div class="content">
    <!-- Personal Information -->
    <div class="card">
      <h3>Personal Information</h3>
      <p class="desc">Update your personal details and contact information</p>

      <!-- Full Name + Username -->
      <div class="form-row">
        <div class="form-group">
          <label for="fullname">Full Name</label>
          <input type="text" id="fullname" value="" disabled> 
          <small>Name cannot be changed</small>
        </div>
        <div class="form-group">
    <label for="role">Role</label>
    <input type="text" id="role" value="" disabled>
    <small>Role cannot be changed</small>
  </div>
      </div>

      <!-- Email + Phone -->
      <div class="form-row">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" value=""disabled>
          <small>Email cannot be changed</small>
        </div>
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="text" id="phone" value=""disabled>
          <small>Phone number cannot be changed</small>
        </div>
      </div>
    </div>

    <!-- Security Settings -->
<!-- Security Settings -->
<div class="card">
  <h3>Security Settings</h3>
  <p class="desc">Update your password and security details</p>

  <div class="form-row">
    <div class="form-group">
      <label for="current-password">Current Password</label>
      <div class="input-wrapper">
        <input type="password" id="current-password" placeholder="Enter current password" disabled>
        <i class="fa-solid fa-eye-slash toggle-password"></i>
      </div>
    </div>
    <div class="form-group">
      <label for="new-password">New Password</label>
      <div class="input-wrapper">
        <input type="password" id="new-password" placeholder="Enter new password" disabled>
        <i class="fa-solid fa-eye-slash toggle-password"></i>
      </div>
    </div>
    <div class="form-group">
      <label for="confirm-password">Confirm Password</label>
      <div class="input-wrapper">
        <input type="password" id="confirm-password" placeholder="Confirm new password" disabled>
        <i class="fa-solid fa-eye-slash toggle-password"></i>
      </div>
    </div>
  </div>

  <!-- Edit, Save, Cancel buttons -->
  <div class="form-actions">
    <button class="btn edit">Edit</button>
    <button class="btn cancel hidden">Cancel</button>
    <button class="btn save hidden">Save Changes</button>
  </div>
</div>

<div id="statusMessage" class="status-message"></div>

    
 <script>
  // üîπ Function to show success/error message at top
function showStatusMessage(message, isError = false) {
  const statusDiv = document.getElementById("statusMessage");
  statusDiv.textContent = message;
  statusDiv.className = isError ? "status-message error" : "status-message";
  statusDiv.style.display = "block";
  setTimeout(() => { statusDiv.style.display = "none"; }, 3000);
}

const userData = localStorage.getItem("user");
let user = null;

if (userData) {
  try { user = JSON.parse(userData); } 
  catch (e) { console.error("‚ùå Error parsing user data:", e); }
}

if (user && user.email) {
  fetch(`http://localhost:3000/settings?email=${encodeURIComponent(user.email)}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const u = data.user;
        document.getElementById("fullname").value = u.fullName || "";
        document.getElementById("role").value = u.role || "";
        document.getElementById("email").value = u.email || "";
        document.getElementById("phone").value = u.phone || "";
        applyRolePermissions(u.role);
      } else {
        alert("‚ö†Ô∏è Failed to load profile information.");
      }
    })
    .catch(err => console.error("‚ùå Error fetching user:", err));
} else {
  alert("‚ö†Ô∏è No user logged in.");
}

// Initial Role Permissions
function applyRolePermissions(role) {
  const phoneInput = document.getElementById("phone");
  const fullnameInput = document.getElementById("fullname");
  const emailInput = document.getElementById("email");
  const passwordFields = document.querySelectorAll("#current-password, #new-password, #confirm-password");
  const phoneNote = document.querySelector("#phone + small"); // the small text under phone

  if (role.toLowerCase() === "staff") {
    fullnameInput.disabled = true;
    emailInput.disabled = true;
    phoneInput.disabled = true;
    passwordFields.forEach(f => f.disabled = true);
    phoneNote.style.display = "block";
  } else if (role.toLowerCase() === "manager") {
    fullnameInput.disabled = true;
    emailInput.disabled = true;
    phoneInput.disabled = true;
    passwordFields.forEach(f => f.disabled = true);
    phoneNote.style.display = "none";
  }
}

// Toggle edit mode
const editBtn = document.querySelector(".btn.edit");
const cancelBtn = document.querySelector(".btn.cancel");
const saveBtn = document.querySelector(".btn.save");
const passwordFields = document.querySelectorAll("#current-password, #new-password, #confirm-password");

editBtn.addEventListener("click", (e) => {
  e.preventDefault();
  passwordFields.forEach(f => f.disabled = false); // enable fields
  cancelBtn.classList.remove("hidden");
  saveBtn.classList.remove("hidden");
  editBtn.classList.add("hidden");
});

cancelBtn.addEventListener("click", (e) => {
  e.preventDefault();
  passwordFields.forEach(f => f.disabled = true);
  passwordFields.forEach(f => f.value = ""); // clear inputs
  cancelBtn.classList.add("hidden");
  saveBtn.classList.add("hidden");
  editBtn.classList.remove("hidden");
});

function saveChanges() {
  const payload = {
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    currentPassword: document.getElementById("current-password").value.trim(),
    newPassword: document.getElementById("new-password").value.trim(),
    confirmPassword: document.getElementById("confirm-password").value.trim()
  };

  // üîπ Check if no fields are filled
  if (!payload.currentPassword && !payload.newPassword && !payload.confirmPassword) {
    showStatusMessage("‚ö†Ô∏è No changes to save. Please enter your current and new password.", true);
    return;
  }

  // üîπ Password validation
  if (payload.newPassword || payload.confirmPassword) {
    if (!payload.currentPassword) {
      showStatusMessage("‚ö†Ô∏è Please enter your current password.", true);
      return;
    }
    if (payload.newPassword !== payload.confirmPassword) {
      showStatusMessage("‚ö†Ô∏è New password and confirmation do not match.", true);
      return;
    }
    if (payload.newPassword.length < 6) {
      showStatusMessage("‚ö†Ô∏è New password must be at least 6 characters.", true);
      return;
    }
  }

  // üîπ Proceed with update
  fetch("http://localhost:3000/settings/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showStatusMessage("‚úÖ Profile updated successfully!");
        const updatedUser = { ...user, phone: payload.phone };
        localStorage.setItem("user", JSON.stringify(updatedUser));

        // Clear password fields and disable them again
        passwordFields.forEach(f => {
          f.value = "";
          f.disabled = true;
        });

        cancelBtn.classList.add("hidden");
        saveBtn.classList.add("hidden");
        editBtn.classList.remove("hidden");
      } else {
        showStatusMessage("‚ùå " + data.message, true);
      }
    })
    .catch(err => {
      console.error("Error updating profile:", err);
      showStatusMessage("‚ùå Failed to update profile. Please try again.", true);
    });
}


// Save button
saveBtn.addEventListener("click", (e) => { e.preventDefault(); saveChanges(); });

// Toggle password visibility
document.querySelectorAll(".toggle-password").forEach(icon => {
  icon.addEventListener("click", () => {
    const input = icon.previousElementSibling;
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  });
});
</script>

</body>
</html>
