<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alerts Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="alert.css" />
</head>
<body>
  <div class="alerts-container">
    <!-- üîπ FILTERS -->
    <div class="filters">
      <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" placeholder="Search alerts..." />
      </div>
      <select>
        <option value="">Severity</option>
        <option value="Critical">Critical</option>
        <option value="Warning">Warning</option>
        <option value="Info">Info</option>
      </select>
      <select>
        <option value="">All Status</option>
        <option value="New">New</option>
        <option value="Acknowledged">Acknowledged</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>

    <!-- üîπ TABLE -->
    <div class="table-container">
      <table class="alerts-table">
        <thead>
          <tr>
            <th>Alert ID</th>
            <th>Type</th>
            <th>Product</th>
            <th>Severity</th>
            <th>Triggered At</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- üîπ PAGINATION -->
    <div class="pagination">
      <p>Showing 1 to 5 of 10 alerts</p>
      <div class="pages">
        <button disabled>Previous</button>
        <button class="active">1</button>
        <button>2</button>
        <button>3</button>
        <button>Next</button>
      </div>
    </div>
  </div>
<!-- Alert Details Modal -->
<div class="modal-overlay" id="alertModal">
  <div class="modal">
    <button class="close-btn" id="closeModal">&times;</button>
    <h2>Alert Details</h2>
    <div id="modalContent" class="info-grid">
      <!-- Info boxes will be inserted dynamically -->
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalOverlay = document.getElementById("alertModal");
  const modalContent = document.getElementById("modalContent");
  const closeModalBtn = document.getElementById("closeModal");

  closeModalBtn.addEventListener("click", () => (modalOverlay.style.display = "none"));
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) modalOverlay.style.display = "none";
  });

  const userRole = (localStorage.getItem("role") || "staff").toLowerCase();
  const tableBody = document.querySelector(".alerts-table tbody");
  const searchInput = document.querySelector(".search-box input");
  const severityFilter = document.querySelectorAll("select")[0];
  const statusFilter = document.querySelectorAll("select")[1];
  const paginationContainer = document.querySelector(".pages");
  const paginationInfo = document.querySelector(".pagination p");

  let alerts = [];
  let currentPage = 1;
  const rowsPerPage = 5;

  // -----------------------------
  // SAVE ALERT TO DATABASE
  // -----------------------------
  async function saveAlert(alert) {
    try {
      console.log("üì§ Sending alert to backend:", alert);
      const res = await fetch("http://localhost:3000/stored-alerts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: alert.name,
          stock: alert.stock,
          status: alert.status || "New",
          createdAt: alert.createdAt,
        }),
      });
      console.log("‚úÖ Response status:", res.status);
      const data = await res.json();
      console.log("‚úÖ Response data:", data);
    } catch (err) {
      console.error("‚ùå Failed to store alert:", err);
    }
  }

  // -----------------------------
  // LOAD ALERTS
  // -----------------------------
  async function loadAlerts() {
    try {
      // Fetch dynamic alerts (based on low stock)
      const response = await fetch("http://localhost:3000/alert");
      if (!response.ok) throw new Error("Failed to fetch alerts");
      alerts = await response.json();

      // Fetch stored alerts to avoid duplicates
      const storedResponse = await fetch("http://localhost:3000/stored-alerts");
      if (!storedResponse.ok) throw new Error("Failed to fetch stored alerts");
      const storedAlerts = await storedResponse.json();

      const existingKeys = storedAlerts.map(a => `${a.name}-${a.stock}`);

      // Save only new alerts (not already stored)
      for (const alert of alerts) {
        const key = `${alert.name}-${alert.stock}`;
        if (!existingKeys.includes(key)) {
          await saveAlert(alert);
        }
      }

      renderTable();
    } catch (error) {
      console.error("‚ùå Error fetching alerts:", error);
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align:center;color:red;">Error loading alerts</td>
        </tr>`;
    }
  }

  // -----------------------------
  // SEVERITY HELPER
  // -----------------------------
  function getSeverity(stock) {
    if (stock === 0) return "Critical";
    if (stock <= 5) return "Warning";
    return "Info";
  }

  // -----------------------------
  // OPEN INVENTORY PAGE
  // -----------------------------
  function openInventoryPage() {
    if (parent && typeof parent.changePage === "function") {
      const inventoryMenu = parent.document.querySelector(
        "li[onclick*='inventory-management.html']"
      );
      parent.changePage(
        "Inventory Management",
        "Track and manage inventory",
        inventoryMenu,
        "../Contents/inventory-management.html"
      );
    } else {
      console.warn("‚ö†Ô∏è parent.changePage not found.");
    }
  }

  // -----------------------------
  // RENDER ALERT TABLE
  // -----------------------------
  function renderTable() {
    tableBody.innerHTML = "";

    const filtered = alerts.filter((alert) => {
      const searchMatch = alert.name?.toLowerCase().includes(searchInput.value.toLowerCase());
      const severity = getSeverity(alert.stock);
      const severityMatch = !severityFilter.value || severity === severityFilter.value;
      const statusMatch = !statusFilter.value || alert.status === statusFilter.value;
      return searchMatch && severityMatch && statusMatch;
    });

    const start = (currentPage - 1) * rowsPerPage;
    const paginated = filtered.slice(start, start + rowsPerPage);

    if (paginated.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No alerts found</td></tr>`;
      updatePaginationInfo(0);
      renderPagination(0);
      return;
    }

    paginated.forEach((alert, index) => {
      const status = alert.status || "New";
      const severity = getSeverity(alert.stock);
      const tr = document.createElement("tr");

      const actionButtons = `
        <button class="action-btn resolve" title="Resolve Alert">
          <i class="fa fa-check"></i> Resolve
        </button>
      `;

      const clickableStatus =
        status === "Resolved"
          ? `<span class="status resolved clickable-status">${status}</span>`
          : `<span class="status ${status.toLowerCase()}">${status}</span>`;

      tr.innerHTML = `
        <td><a href="#" class="view-link">ALT-${start + index + 1}</a></td>
        <td>${alert.stock === 0 ? "Out of Stock" : "Low Stock"}</td>
        <td>${alert.name || "N/A"}</td>
        <td><span class="badge ${severity.toLowerCase()}">${severity}</span></td>
        <td>${new Date(alert.createdAt).toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        })}</td>
        <td>${clickableStatus}</td>
        <td>${actionButtons}</td>
      `;

      tableBody.appendChild(tr);

      // Resolve button ‚Üí open inventory
      const resolveBtn = tr.querySelector(".resolve");
      if (resolveBtn) resolveBtn.addEventListener("click", openInventoryPage);

      // Resolved status ‚Üí open inventory
      const resolvedStatus = tr.querySelector(".clickable-status");
      if (resolvedStatus) {
        resolvedStatus.style.color = "#007bff";
        resolvedStatus.style.cursor = "pointer";
        resolvedStatus.title = "Go to Inventory Management";
        resolvedStatus.addEventListener("click", openInventoryPage);
      }
    });

    updatePaginationInfo(filtered.length);
    renderPagination(filtered.length);
  }

  // -----------------------------
  // PAGINATION
  // -----------------------------
  function renderPagination(total) {
    paginationContainer.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));

    const prev = document.createElement("button");
    prev.textContent = "Previous";
    prev.disabled = currentPage === 1 || total <= rowsPerPage;
    prev.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    paginationContainer.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable();
      });
      paginationContainer.appendChild(btn);
    }

    const next = document.createElement("button");
    next.textContent = "Next";
    next.disabled = currentPage === totalPages || total <= rowsPerPage;
    next.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    });
    paginationContainer.appendChild(next);
  }

  function updatePaginationInfo(total) {
    const start = total === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    const end = Math.min(currentPage * rowsPerPage, total);
    paginationInfo.textContent = `Showing ${start} to ${end} of ${total} alerts`;
  }

  // -----------------------------
  // FILTER EVENTS
  // -----------------------------
  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });
  severityFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });
  statusFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // -----------------------------
  // INITIAL LOAD
  // -----------------------------
  loadAlerts();
});
</script>



</body>
</html>
