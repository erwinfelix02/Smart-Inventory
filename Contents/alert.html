<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alerts Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="alert.css" />
</head>
<body>
  <div class="alerts-container">
    <!-- üîπ FILTERS -->
    <div class="filters">
      <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" placeholder="Search alerts..." />
      </div>
      <select>
        <option value="">Severity</option>
        <option value="Critical">Critical</option>
        <option value="Warning">Warning</option>
        <option value="Info">Info</option>
      </select>
      <select>
        <option value="">All Status</option>
        <option value="New">New</option>
        <option value="Acknowledged">Acknowledged</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>

    <!-- üîπ TABLE -->
    <div class="table-container">
      <table class="alerts-table">
        <thead>
          <tr>
            <th>Alert ID</th>
            <th>Type</th>
            <th>Product</th>
            <th>Severity</th>
            <th>Triggered At</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- üîπ PAGINATION -->
    <div class="pagination">
      <p>Showing 1 to 5 of 10 alerts</p>
      <div class="pages">
        <button disabled>Previous</button>
        <button class="active">1</button>
        <button>2</button>
        <button>3</button>
        <button>Next</button>
      </div>
    </div>
  </div>
<!-- Alert Details Modal -->
<div class="modal-overlay" id="alertModal">
  <div class="modal">
    <button class="close-btn" id="closeModal">&times;</button>
    <h2>Alert Details</h2>
    <div id="modalContent" class="info-grid">
      <!-- Info boxes will be inserted dynamically -->
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalOverlay = document.getElementById("alertModal");
  const modalContent = document.getElementById("modalContent");
  const closeModalBtn = document.getElementById("closeModal");

  closeModalBtn.addEventListener("click", () => {
    modalOverlay.style.display = "none";
  });

  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) modalOverlay.style.display = "none";
  });

  // ‚úÖ Load role from localStorage
  const userRole = (localStorage.getItem("role") || "staff").toLowerCase();


  console.log("Current role:", userRole);

  const tableBody = document.querySelector(".alerts-table tbody");
  const searchInput = document.querySelector(".search-box input");
  const severityFilter = document.querySelectorAll("select")[0];
  const statusFilter = document.querySelectorAll("select")[1];
  const paginationContainer = document.querySelector(".pages");
  const paginationInfo = document.querySelector(".pagination p");

  let alerts = [];
  let currentPage = 1;
  const rowsPerPage = 5;

  // ‚úÖ Fetch alerts
  async function loadAlerts() {
    try {
      const response = await fetch("http://localhost:3000/alert");
      if (!response.ok) throw new Error("Failed to fetch alerts");
      alerts = await response.json();
      renderTable();
    } catch (error) {
      console.error("‚ùå Error fetching alerts:", error);
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Error loading alerts</td></tr>`;
    }
  }

  function getSeverity(stock) {
    if (stock === 0) return "Critical";
    if (stock <= 5) return "Warning";
    return "Info";
  }

  function renderTable() {
    tableBody.innerHTML = "";

    const filtered = alerts.filter(alert => {
      const searchMatch = alert.name?.toLowerCase().includes(searchInput.value.toLowerCase());
      const severity = getSeverity(alert.stock);
      const severityMatch = !severityFilter.value || severity === severityFilter.value;
      const statusMatch = !statusFilter.value || alert.status === statusFilter.value;
      return searchMatch && severityMatch && statusMatch;
    });

    const start = (currentPage - 1) * rowsPerPage;
    const paginated = filtered.slice(start, start + rowsPerPage);

    if (paginated.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No alerts found</td></tr>`;
      return;
    }

    paginated.forEach((alert, index) => {
      
      const status = alert.status || "New";
      const tr = document.createElement("tr");

      // ‚úÖ Role-based actions
            // ‚úÖ Role-based actions
      let actionButtons = "";
      const severity = getSeverity(alert.stock);

      if ((userRole === "admin" || userRole === "manager") && (severity === "Critical" || severity === "Warning")) {
        // Show Resolve button only if severity is Critical (No Stock) or Warning (Low Stock)
        actionButtons = `
          <button class="action-btn resolve" title="Resolve Alert">
            <i class="fa fa-check"></i> Resolve
          </button>`;
      } else if (userRole === "staff") {
        actionButtons = `
          <button class="action-btn view" title="View Details">
            <i class="fa fa-eye"></i>
          </button>`;
      } else {
        actionButtons = `<span class="no-action">No action</span>`;
      }


      tr.innerHTML = `
        <td><a href="#" class="view-link">ALT-${start + index + 1}</a></td>
        <td>${alert.stock === 0 ? "No Stock" : "Low Stock"}</td>
        <td>${alert.name || "N/A"}</td>
        <td><span class="badge ${severity.toLowerCase()}">${severity}</span></td>
        <td>${new Date(alert.createdAt).toLocaleString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true
          })}</td>

        <td><span class="status ${status.toLowerCase()}">${status}</span></td>
        <td>${actionButtons}</td>
      `;
      tableBody.appendChild(tr);

      // ‚úÖ View modal (for staff)
      const viewBtn = tr.querySelector(".view");
      if (viewBtn) {
        viewBtn.addEventListener("click", () => {
         modalContent.innerHTML = `
  <div class="info-box">
    <span class="info-title">Product</span>
    <span class="info-value">${alert.name || "N/A"}</span>
  </div>
  <div class="info-box">
    <span class="info-title">Type</span>
    <span class="info-value">${alert.stock === 0 ? "No Stock" : "Low Stock"}</span>
  </div>
  <div class="info-box">
    <span class="info-title">Severity</span>
    <span class="info-value severity ${severity.toLowerCase()}">${severity}</span>
  </div>
  <div class="info-box">
    <span class="info-title">Status</span>
    <span class="info-value status ${status.toLowerCase()}">${status}</span>
  </div>
  <div class="info-box">
    <span class="info-title">Stock</span>
    <span class="info-value">${alert.stock}</span>
  </div>
  <div class="info-box">
    <span class="info-title">Triggered At</span>
   <span class="info-value">
  ${new Date(alert.createdAt).toLocaleString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  })}
</span>

  </div>
`;

          modalOverlay.style.display = "flex";
        });
      }

      // ‚úÖ Resolve button (for admin/manager)
      const resolveBtn = tr.querySelector(".resolve");
      if (resolveBtn) {
        resolveBtn.addEventListener("click", async () => {
          const confirmResolve = confirm(`Mark "${alert.name}" as resolved?`);
          if (!confirmResolve) return;

          // Example backend call (optional)
          try {
            const res = await fetch(`http://localhost:3000/alert/${alert._id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: "Resolved" }),
            });
            if (res.ok) {
              alert(`‚úÖ "${alert.name}" marked as resolved.`);
              loadAlerts(); // reload table
            } else {
              alert("‚ùå Failed to update alert status.");
            }
          } catch (err) {
            console.error(err);
            alert("‚ö†Ô∏è Error connecting to server.");
          }
        });
      }
    });

    updatePaginationInfo(filtered.length);
    renderPagination(filtered.length);
  }

  function renderPagination(total) {
    paginationContainer.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));

    const prev = document.createElement("button");
    prev.textContent = "Previous";
    prev.disabled = currentPage === 1 || total <= rowsPerPage;
    prev.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    paginationContainer.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable();
      });
      paginationContainer.appendChild(btn);
    }

    const next = document.createElement("button");
    next.textContent = "Next";
    next.disabled = currentPage === totalPages || total <= rowsPerPage;
    next.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    });
    paginationContainer.appendChild(next);
  }

  function updatePaginationInfo(total) {
    const start = total === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    const end = Math.min(currentPage * rowsPerPage, total);
    paginationInfo.textContent = `Showing ${start} to ${end} of ${total} alerts`;
  }

  // üîπ Event listeners for filters
  searchInput.addEventListener("input", () => { currentPage = 1; renderTable(); });
  severityFilter.addEventListener("change", () => { currentPage = 1; renderTable(); });
  statusFilter.addEventListener("change", () => { currentPage = 1; renderTable(); });

  loadAlerts();
});
</script>

</body>
</html>
