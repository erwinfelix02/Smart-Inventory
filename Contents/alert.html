<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alerts Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="alert.css" />
</head>
<body>
  <div class="alerts-container">
    <!-- 🔹 FILTERS -->
    <div class="filters">
      <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" placeholder="Search alerts..." />
      </div>
      <select>
        <option value="">Severity</option>
        <option value="Warning">Warning</option>
        <option value="Low-stock">Low Stock</option>
        <option value="Critical">Critical</option>
        <option value="Out-of-stock">Out of Stock</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="New">New</option>
        <option value="1 day ago">1 day ago</option>
        <option value="2 days ago">2 days ago</option>
        <option value="3 days ago">3 days ago</option>
        <option value="4 days ago">4 days ago</option>
        <option value="5 days ago">5 days ago</option>
        <option value="6 days ago">6 days ago</option>
        <option value="1 week ago">1 week ago</option>
        <option value="Older">Older</option>
      </select>

    </div>

    <!-- 🔹 TABLE -->
    <div class="table-container">
      <table class="alerts-table">
        <thead>
          <tr>
            <th>Alert ID</th>
            <th>Type</th>
            <th>Product</th>
            <th>Severity</th>
            <th>Triggered At</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 🔹 PAGINATION -->
    <div class="pagination">
      <p>Showing 1 to 5 of 10 alerts</p>
      <div class="pages">
        <button disabled>Previous</button>
        <button class="active">1</button>
        <button>2</button>
        <button>3</button>
        <button>Next</button>
      </div>
    </div>
  </div>
<!-- Alert Details Modal -->
<div class="modal-overlay" id="alertModal">
  <div class="modal">
    <button class="close-btn" id="closeModal">&times;</button>
    <h2>Alert Details</h2>
    <div id="modalContent" class="info-grid">
      <!-- Info boxes will be inserted dynamically -->
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalOverlay = document.getElementById("alertModal");
  const modalContent = document.getElementById("modalContent");
  const closeModalBtn = document.getElementById("closeModal");

  closeModalBtn.addEventListener("click", () => (modalOverlay.style.display = "none"));
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) modalOverlay.style.display = "none";
  });

  const userRole = (localStorage.getItem("role") || "staff").toLowerCase();
  const tableBody = document.querySelector(".alerts-table tbody");
  const searchInput = document.querySelector(".search-box input");
  const severityFilter = document.querySelectorAll("select")[0];
  const statusFilter = document.querySelectorAll("select")[1];
  const paginationContainer = document.querySelector(".pages");
  const paginationInfo = document.querySelector(".pagination p");

  let alerts = [];
  let currentPage = 1;
  const rowsPerPage = 5;


  let thresholds = {
  critical: 0, // Out of Stock
  low: 5,      // Low stock warning
  warning: 10  // Optional warning
};

// Map the <select> values to the actual severity returned by getSeverity()
function mapSeverityFilter(value) {
  switch(value) {
    case "Out-of-stock": return "Out-of-stock";
    case "Critical": return "Critical";
    case "Low-stock": return "Low-stock";
    case "Warning": return "Warning";
     return value || null;
  }
}


// Or fetch from backend dynamically:
async function loadThresholds() {
  try {
    const res = await fetch("http://localhost:3000/system-settings");
    const data = await res.json();
    thresholds.critical = data.critical_stock_threshold ?? 0;
    thresholds.low = data.low_stock_threshold ?? 5;
    thresholds.warning = data.warning_stock_threshold ?? 10;
  } catch (err) {
    console.error("Failed to load thresholds, using defaults:", err);
  }
}

  // -----------------------------
  // SAVE ALERT TO DATABASE
  // -----------------------------
  async function saveAlert(alert) {
    try {
      console.log("📤 Sending alert to backend:", alert);
      const res = await fetch("http://localhost:3000/stored-alerts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: alert.name,
          stock: alert.stock,
          status: alert.status || "New",
          createdAt: alert.createdAt,
        }),
      });
      console.log("✅ Response status:", res.status);
      const data = await res.json();
      console.log("✅ Response data:", data);
    } catch (err) {
      console.error("❌ Failed to store alert:", err);
    }
  }

  // -----------------------------
// LOAD ALERTS
// -----------------------------
async function loadAlerts() {
  await loadThresholds(); // ensure thresholds are loaded

  try {
    const res = await fetch("http://localhost:3000/products");
    const products = await res.json();

    // Generate alerts for any product under warning threshold
    alerts = products
      .filter(p => p.stock <= thresholds.warning) // Include Warning, Low, Critical, Out-of-stock
      .map(p => ({
        name: p.name,
        stock: p.stock,
        status: "New",
        createdAt: p.updatedAt || p.createdAt || new Date()
      }));

    // Save new alerts to DB
    for (const alert of alerts) {
      await saveAlert(alert);
    }

    renderTable();
  } catch (err) {
    console.error("Error loading alerts:", err);
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center;color:red;">Error loading alerts</td>
      </tr>`;
  }
}

// -----------------------------
// SEVERITY HELPER
// -----------------------------
function getSeverity(stock) {
  if (stock === 0) return "Out-of-stock";
  if (stock <= thresholds.critical) return "Critical";
  if (stock <= thresholds.low) return "Low-stock";
  if (stock <= thresholds.warning) return "Warning";
  return "Normal"; // optional fallback
}




  // -----------------------------
  // OPEN INVENTORY PAGE
  // -----------------------------
  function openInventoryPage() {
    if (parent && typeof parent.changePage === "function") {
      const inventoryMenu = parent.document.querySelector(
        "li[onclick*='inventory-management.html']"
      );
      parent.changePage(
        "Inventory Management",
        "Track and manage inventory",
        inventoryMenu,
        "../Contents/inventory-management.html"
      );
    } else {
      console.warn("⚠️ parent.changePage not found.");
    }
  }


function updateStatusFilterOptions() {
  const statusSet = new Set(alerts.map(a => getAlertAgeStatus(a.createdAt)));
  const statusFilter = document.getElementById("statusFilter");

  // Save currently selected value
  const selectedValue = statusFilter.value;

  // Rebuild the options
  statusFilter.innerHTML = '<option value="">All Status</option>';

  Array.from(statusSet)
    .sort((a, b) => {
      const order = ["New", "1 day ago", "2 days ago", "3 days ago", "4 days ago", "5 days ago", "6 days ago", "1 week ago", "Older"];
      return order.indexOf(a) - order.indexOf(b);
    })
    .forEach(status => {
      const opt = document.createElement("option");
      opt.value = status;
      opt.textContent = status;
      statusFilter.appendChild(opt);
    });

  // Restore previously selected value
  statusFilter.value = selectedValue;
}


  // -----------------------------
  // RENDER ALERT TABLE
  // -----------------------------
  function renderTable() {
      updateStatusFilterOptions();
    tableBody.innerHTML = "";

const filtered = alerts.filter(alert => {
  const searchMatch = alert.name?.toLowerCase().includes(searchInput.value.toLowerCase());
  const severity = getSeverity(alert.stock);
  const severityMatch = !severityFilter.value || severity === severityFilter.value;
    const ageStatus = getAlertAgeStatus(alert.createdAt);
  const statusMatch = !statusFilter.value || ageStatus === statusFilter.value;

  return searchMatch && severityMatch && statusMatch;
});


    const start = (currentPage - 1) * rowsPerPage;
    const paginated = filtered.slice(start, start + rowsPerPage);

    if (paginated.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No alerts found</td></tr>`;
      updatePaginationInfo(0);
      renderPagination(0);
      return;
    }

    paginated.forEach((alert, index) => {
 const status = getAlertAgeStatus(alert.createdAt);
  const severity = getSeverity(alert.stock);

  // Map severity to display type
let typeText = "";
switch(severity) {
  case "Out-of-stock": typeText = "Out of Stock"; break;
  case "Critical": typeText = "Critical Stock"; break;
  case "Low-stock": typeText = "Low Stock"; break;
  case "Warning": typeText = "Warning"; break;
}


  const tr = document.createElement("tr");

  const actionButtons = `
    <button class="action-btn resolve" title="Resolve Alert">
      <i class="fa fa-check"></i> Resolve
    </button>
  `;

  const clickableStatus =
    status === "Resolved"
      ? `<span class="status resolved clickable-status">${status}</span>`
      : `<span class="status ${status.toLowerCase()}">${status}</span>`;

  tr.innerHTML = `
    <td><a href="#" class="view-link">ALT-${start + index + 1}</a></td>
    <td>${typeText}</td>
    <td>${alert.name || "N/A"}</td>
    <td><span class="badge ${severity.toLowerCase()}">${severity}</span></td>
    <td>${new Date(alert.createdAt).toLocaleString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    })}</td>
    <td>${clickableStatus}</td>
    <td>${actionButtons}</td>
  `;

  tableBody.appendChild(tr);

  // Resolve button → open inventory
  const resolveBtn = tr.querySelector(".resolve");
  if (resolveBtn) resolveBtn.addEventListener("click", openInventoryPage);

  // Resolved status → open inventory
  const resolvedStatus = tr.querySelector(".clickable-status");
  if (resolvedStatus) {
    resolvedStatus.style.color = "#007bff";
    resolvedStatus.style.cursor = "pointer";
    resolvedStatus.title = "Go to Inventory Management";
    resolvedStatus.addEventListener("click", openInventoryPage);
  }
});


    updatePaginationInfo(filtered.length);
    renderPagination(filtered.length);
  }



  // -----------------------------
// STATUS BASED ON AGE
// -----------------------------
function getAlertAgeStatus(createdAt) {
  const now = new Date();
  const alertDate = new Date(createdAt);
  const diffTime = now - alertDate;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "New";
  if (diffDays === 1) return "1 day ago";
  if (diffDays >= 2 && diffDays <= 6) return `${diffDays} days ago`;
  if (diffDays === 7) return "1 week ago";
  return "Older";
}

  // -----------------------------
  // PAGINATION
  // -----------------------------
  function renderPagination(total) {
    paginationContainer.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));

    const prev = document.createElement("button");
    prev.textContent = "Previous";
    prev.disabled = currentPage === 1 || total <= rowsPerPage;
    prev.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    paginationContainer.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable();
      });
      paginationContainer.appendChild(btn);
    }

    const next = document.createElement("button");
    next.textContent = "Next";
    next.disabled = currentPage === totalPages || total <= rowsPerPage;
    next.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    });
    paginationContainer.appendChild(next);
  }

  function updatePaginationInfo(total) {
    const start = total === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    const end = Math.min(currentPage * rowsPerPage, total);
    paginationInfo.textContent = `Showing ${start} to ${end} of ${total} alerts`;
  }

  // -----------------------------
  // FILTER EVENTS
  // -----------------------------
  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });
  severityFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });
  statusFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // -----------------------------
  // INITIAL LOAD
  // -----------------------------
  loadAlerts();
});
</script>



</body>
</html>
