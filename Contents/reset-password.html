<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Inventory</title>
  <link rel="icon" type="image/png" href="../images/logo.svg">
  <link rel="stylesheet" href="reset-password.css" />
</head>
<body>
  <div class="reset-container">
    <div class="image-side">
      <img src="../images/signin.svg" alt="Reset Illustration">
    </div>

<div class="container">
  <!-- Animated Gradient Background -->
  <div class="image-side"></div>

  <!-- Reset Form -->
  <div class="form-side">
    <div class="forgot">
      <img src="../images/LOGO2.svg" alt="Reset Illustration" class="forgot-logo">
      <h2>Reset Password</h2>
      <p class="subtitle">Set your new password below</p>

      <form id="resetForm">
        <div class="input-group">
          <label for="new-password">New Password</label>
          <i class="fa-solid fa-lock"></i>
          <input type="password" id="new-password" placeholder="Enter new password" required>
        </div>

        <div class="input-group">
          <label for="confirm-password">Confirm Password</label>
          <i class="fa-solid fa-lock"></i>
          <input type="password" id="confirm-password" placeholder="Confirm new password" required>
        </div>

        <div class="error-text" id="passwordError"></div>
        <button type="submit" class="btn">Update Password</button>
        <a href="../Landing Page/signin.html" class="back-login">Back to Sign In</a>
      </form>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="overlay" id="overlay">
  <div class="spinner"></div>
</div>


 <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("resetForm");
  const newPasswordInput = document.getElementById("new-password");
  const confirmPasswordInput = document.getElementById("confirm-password");
  const updateBtn = form.querySelector("button");

  // Create individual error divs under each input
  const newPasswordError = document.createElement("div");
  newPasswordError.className = "error-text";
  newPasswordInput.parentNode.appendChild(newPasswordError);

  const confirmPasswordError = document.createElement("div");
  confirmPasswordError.className = "error-text";
  confirmPasswordInput.parentNode.appendChild(confirmPasswordError);

  const overlay = document.getElementById("overlay"); // loading overlay

  // Get email from query string (?email=someone@gmail.com)
  const urlParams = new URLSearchParams(window.location.search);
  const email = urlParams.get("email");

  if (!email) {
    newPasswordError.textContent = "No email provided for password reset.";
    updateBtn.disabled = true;
    updateBtn.textContent = "Missing email";
    return;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const newPassword = newPasswordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();

    // Clear previous errors
    newPasswordError.textContent = "";
    confirmPasswordError.textContent = "";
    newPasswordError.style.color = "#e74c3c";
    confirmPasswordError.style.color = "#e74c3c";

    // Validation
    let hasError = false;

    if (!newPassword) {
      newPasswordError.textContent = "Enter a new password";
      hasError = true;
    } else if (newPassword.length < 6) {
      newPasswordError.textContent = "Password must be at least 6 characters long";
      hasError = true;
    }

    if (!confirmPassword) {
      confirmPasswordError.textContent = "Confirm your password";
      hasError = true;
    } else if (newPassword !== confirmPassword) {
      confirmPasswordError.textContent = "Passwords do not match";
      hasError = true;
    }

    if (hasError) return;

    // Show loading overlay
    overlay.style.display = "flex";
    updateBtn.disabled = true;
    updateBtn.textContent = "Updating...";

    try {
      const response = await fetch("http://localhost:3000/users/reset-password", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, newPassword }),
      });

      const data = await response.json();

      if (response.ok) {
        newPasswordError.style.color = "#4CAF50"; // green
        newPasswordError.textContent = "✅ Password reset successfully! Redirecting...";
        setTimeout(() => {
          window.location.href = "../Landing Page/signin.html";
        }, 2000);
      } else {
        newPasswordError.style.color = "#e74c3c"; // red
        newPasswordError.textContent = data.message || "❌ Failed to reset password. Please try again.";
      }
    } catch (err) {
      console.error("Error:", err);
      newPasswordError.style.color = "#e74c3c";
      newPasswordError.textContent = "⚠️ Something went wrong. Please try again later.";
    } finally {
      updateBtn.disabled = false;
      updateBtn.textContent = "Update Password";
      overlay.style.display = "none";
    }
  });
});
</script>

</body>
</html>
