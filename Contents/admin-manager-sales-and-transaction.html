<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Dashboard</title>
  <link rel="stylesheet" href="admin-manager-sales-and-transaction.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
</head>
<body>
  <div class="dashboard-container">

    <!-- ðŸ”¹ Top Section -->
    <div class="top-section">
      
      <!-- ðŸ”¸ Summary Metrics -->
      <div class="card summary-card">
        <div class="metric-cards">
          <div class="metric-item sales">
            <div>
              <h3>Today's Sales</h3>
              <p class="amount">â‚±45,280</p>
              <small class="positive">â†‘ 12.5% vs yesterday</small>
            </div>
            <div class="icon"><i class="fa fa-chart-line"></i></div>
          </div>

          <div class="metric-item transactions">
            <div>
              <h3>Transactions</h3>
              <p class="amount">127</p>
              <small class="neutral">+8 new today</small>
            </div>
            <div class="icon"><i class="fa fa-receipt"></i></div>
          </div>

          <div class="metric-item avg-order">
            <div>
              <h3>Avg. Order Value</h3>
              <p class="amount">â‚±356</p>
              <small class="negative">â†“ 2.1% vs last week</small>
            </div>
            <div class="icon"><i class="fa fa-dollar-sign"></i></div>
          </div>
        </div>
      </div>

      <!-- ðŸ”¸ Low Stock Alerts -->
      <div class="card alerts-card">
        <h3>Low Stock Alerts</h3>
        <div class="alert-list">
          <div class="alert-item">
            <i class="fa fa-box"></i>
            <div class="alert-details">
              <p>Wireless Bluetooth Headphones</p>
              <small>SKU: WBH-001</small>
            </div>
            <span class="units">5 units left</span>
          </div>

          <div class="alert-item">
            <i class="fa fa-box"></i>
            <div class="alert-details">
              <p>USB-C Fast Charger</p>
              <small>SKU: CHG-112</small>
            </div>
            <span class="units">3 units left</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ Sales Trend -->
   <div class="card trend">
  <div class="trend-header">
    <h3>Sales Trend</h3>
    <div class="btn-group">
      <button class="btn active">Daily</button>
      <button class="btn">Weekly</button>
      <button class="btn">Monthly</button>
    </div>
  </div>

  <div class="chart-wrapper">
    <canvas id="salesTrendChart"></canvas>
  </div>
</div>


    <!-- ðŸ”¹ Recent Transactions -->
    <div class="card transactions">
      <div class="transactions-header">
        <h3>Recent Transactions</h3>
        <select>
          <option>All Status</option>
          <option>Completed</option>
          <option>Pending</option>
          <option>Cancelled</option>
        </select>
      </div>

      <table>
        <thead>
          <tr>
            <th>TRANSACTION ID</th>
            <th>DATE/TIME</th>
            <th>SALES REP</th>
            <th>ITEMS SUMMARY</th>
            <th>TOTAL</th>
            <th>STATUS</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
       <tbody id="transactions-body">
          <tr>
            <td>#TXN-001234</td>
            <td>Dec 15, 2024 2:30 PM</td>
            <td>Dhie Nacrushback</td>
            <td>iPhone 14 Pro x2, AirPods Pro x1</td>
            <td>â‚±65,890</td>
            <td><span class="badge paid">Paid</span></td>
            <td class="actions">
              <i class="fa fa-eye"></i>
              <i class="fa fa-pen"></i>
              <i class="fa fa-trash"></i>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="table-footer">
        <p>Showing 1 to 10 of 127 results</p>
        <div class="pagination">
          <button>Previous</button>
          <button class="active">1</button>
          <button>2</button>
          <button>3</button>
          <button>Next</button>
        </div>
      </div>
    </div>
  </div>

 <!-- Transaction Details Modal -->
<div id="transactionDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Transaction Details</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <table class="modal-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date/Time</th>
            <th>Staff</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="modalBody">
          <!-- Filled dynamically with JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Transaction Modal -->
<div id="transactionEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Transaction</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editTransactionForm">
        <div class="info-grid">
          <div class="info-box">
            <div class="info-title">Transaction ID</div>
            <div class="info-value" id="editTxnId">#TXN-XXXXXX</div>
          </div>
          <div class="info-box">
            <div class="info-title">Date/Time</div>
            <div class="info-value" id="editTxnDate">Dec 15, 2024 2:30 PM</div>
          </div>
          <div class="info-box">
            <div class="info-title">Staff</div>
            <div class="info-value" id="editTxnStaff">Dhie Nacrushback</div>
          </div>
          <div class="info-box">
            <div class="info-title">Items</div>
            <div class="info-value" id="editTxnItems">iPhone 14 x2</div>
          </div>
          <div class="info-box">
            <div class="info-title">Total</div>
            <div class="info-value" id="editTxnTotal">â‚±65,890</div>
          </div>
          <div class="info-box">
            <div class="info-title">Status</div>
           <select id="editTxnStatus">
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
          </div>
        </div>
        <div style="margin-top:20px; text-align:right;">
          <button type="submit" class="btn">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Delete Confirmation Popup -->
<div id="deletePopup" class="popup-overlay">
  <div class="popup-box">
    <i class="fa fa-exclamation-triangle"></i>
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete this transaction?</p>
    <div class="popup-buttons">
      <button id="cancelDelete">Cancel</button>
      <button id="confirmDelete">Confirm</button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ITEMS_PER_PAGE = 5;
let transactions = [];
let currentPage = 1;
let currentFilter = "All Status";

// ------------------------
// Load Today's Sales based on completed transactions
// ------------------------
async function loadTodaysSales() {
  const salesElem = document.querySelector(".metric-item.sales .amount");
  const trendElem = document.querySelector(".metric-item.sales small");
  const transactionsElem = document.querySelector(".metric-item.transactions .amount");
  const transactionsTrendElem = document.querySelector(".metric-item.transactions small");
  const avgOrderElem = document.querySelector(".metric-item.avg-order .amount");

  salesElem.textContent = "Loading...";
  trendElem.textContent = "Loading...";
  transactionsElem.textContent = "Loading...";
  transactionsTrendElem.textContent = "Loading...";
  avgOrderElem.textContent = "Loading...";

  try {
    const res = await fetch("/transactions");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    transactions = await res.json();

    const today = new Date();
    today.setHours(0,0,0,0); // start of today

    // Filter completed transactions of today
    const todaysCompleted = transactions.filter(tx => {
      const txDate = new Date(tx.date);
      txDate.setHours(0,0,0,0);
      return tx.status.toLowerCase() === "completed" && txDate.getTime() === today.getTime();
    });

    // Calculate totals
    const totalSales = todaysCompleted.reduce((sum, tx) => sum + (tx.total || 0), 0);
    const totalTransactions = todaysCompleted.length;
    const avgOrder = totalTransactions ? totalSales / totalTransactions : 0;

    // Update top metrics
    salesElem.textContent = `â‚±${totalSales.toLocaleString()}`;
    trendElem.textContent = `Today's completed sales`; // you can calculate vs yesterday if needed
    trendElem.className = "positive";

    transactionsElem.textContent = totalTransactions;
    transactionsTrendElem.textContent = `All transactions`;
    avgOrderElem.textContent = `â‚±${avgOrder.toLocaleString()}`;

    // After this, render the transactions table as usual
    currentPage = 1;
    renderTransactionsPage();

  } catch (err) {
    console.error("Failed to load today's sales:", err);
    salesElem.textContent = "â‚±0";
    trendElem.textContent = "Error";
    trendElem.className = "negative";
    transactionsElem.textContent = 0;
    transactionsTrendElem.textContent = "+0 new today";
    avgOrderElem.textContent = "â‚± 0";
  }
}


// ------------------------
// Load Low Stock Alerts
// ------------------------
async function loadLowStockAlerts() {
  const alertList = document.querySelector(".alerts-card .alert-list");
  alertList.innerHTML = `<p style="text-align:center;">Loading...</p>`;

  try {
    // Fetch system thresholds
    const settingsRes = await fetch("/system-settings");
    const settings = await settingsRes.json();
    const critical = settings.critical_stock_threshold ?? 2;
    const low = settings.low_stock_threshold ?? 5;
    const warning = settings.warning_stock_threshold ?? 10;

    // Fetch products
    const res = await fetch("/products");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const products = await res.json();
    alertList.innerHTML = "";

    // Only include products that are "low" stock according to system thresholds
    const alertProducts = products.filter(p => {
      if (p.stock === 0) return false;          // Out of Stock handled elsewhere
      if (p.stock <= critical) return false;    // Critical handled elsewhere
      return p.stock <= low;                     // Only low stock
    });

    if (!alertProducts.length) {
      alertList.innerHTML = `<p style="text-align:center;">All stocks are sufficient ðŸŽ‰</p>`;
      return;
    }

    // Render alerts
    alertProducts.forEach(p => {
      let statusClass = "", statusText = "";

      if (p.stock === 0) {
        statusClass = "out";
        statusText = "Out of Stock";
      } else if (p.stock <= critical) {
        statusClass = "critical";
        statusText = "Critical Stock";
      } else if (p.stock <= low) {
        statusClass = "low";
        statusText = "Low Stock";
      } else if (p.stock <= warning) {
        statusClass = "warning";
        statusText = "Warning";
      } else {
        statusClass = "normal";
        statusText = "Normal";
      }

      const div = document.createElement("div");
      div.classList.add("alert-item", statusClass);
      div.innerHTML = `
        <i class="fa fa-box"></i>
        <div class="alert-details">
          <p>${p.name}</p>
          <small>SKU: ${p.sku || "N/A"}</small>
        </div>
        <span class="units">${p.stock} unit${p.stock !== 1 ? "s" : ""} left - ${statusText}</span>
      `;
      alertList.appendChild(div);
    });

  } catch (err) {
    console.error("Failed to load low stock products:", err);
    alertList.innerHTML = `<p style="text-align:center; color:red;">Error loading alerts</p>`;
  }
}



// ------------------------
// Load Recent Transactions
// ------------------------
async function loadRecentTransactions() {
  const tbody = document.getElementById("transactions-body");
  tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>`;

  try {
    const res = await fetch("/transactions");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    transactions = await res.json();
    currentPage = 1;

    document.querySelector(".metric-item.transactions .amount").textContent = transactions.length;
    renderTransactionsPage();
  } catch (err) {
    console.error("Failed to load transactions:", err);
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Error loading transactions</td></tr>`;
    document.querySelector(".metric-item.transactions .amount").textContent = 0;
  }
}

// ------------------------
// Status Filter Dropdown
// ------------------------
const statusSelect = document.querySelector(".transactions-header select");
statusSelect.addEventListener("change", (e) => {
  currentFilter = e.target.value;
  currentPage = 1;
  renderTransactionsPage();
});

// ------------------------
// Render Transactions Table
// ------------------------
function renderTransactionsPage() {
  const tbody = document.getElementById("transactions-body");
  tbody.innerHTML = "";

  let filteredTransactions = transactions;
  if (currentFilter !== "All Status") {
    filteredTransactions = transactions.filter(tx =>
      tx.status.toLowerCase() === currentFilter.toLowerCase()
    );
  }

  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredTransactions.length);
  const pageItems = filteredTransactions.slice(startIndex, endIndex);

  if (!pageItems.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No transactions found</td></tr>`;
  } else {
   pageItems.forEach(tx => {
  const dateTime = new Date(tx.date).toLocaleString("en-PH", { dateStyle: "medium", timeStyle: "short" });
  const productName = tx.product?.name || "Unknown Product";
  const itemsSummary = `${productName} x${tx.quantity}`;
  const badgeClassMap = {
    "Completed": "paid",
    "Pending": "pending",
    "Cancelled": "cancelled"
  };
  const statusClass = badgeClassMap[tx.status] || "pending";

  // Only show edit icon if status is Pending
  const editIcon = tx.status === "Pending" ? `<i class="fa fa-pen"></i>` : "";

  const tr = document.createElement("tr");
  tr.dataset.id = tx._id.toLowerCase();
  tr.innerHTML = `
    <td>#${tx._id.slice(-6).toUpperCase()}</td>
    <td>${dateTime}</td>
    <td>${tx.staffName}</td>
    <td>${itemsSummary}</td>
    <td>â‚±${tx.total.toLocaleString()}</td>
    <td><span class="badge ${statusClass}">${tx.status}</span></td>
    <td class="actions">
      <i class="fa fa-eye"></i>
      ${editIcon}
      <i class="fa fa-trash"></i>
    </td>
  `;
  tbody.appendChild(tr);
});

  }

  const footerText = document.querySelector(".table-footer p");
  footerText.textContent = filteredTransactions.length
    ? `Showing ${startIndex + 1} to ${endIndex} of ${filteredTransactions.length} results`
    : "Showing 0 to 0 of 0 results";

  renderPagination(filteredTransactions.length);
}

// ------------------------
// Render Pagination Controls
// ------------------------
function renderPagination(totalItems = transactions.length) {
  const paginationDiv = document.querySelector(".pagination");
  paginationDiv.innerHTML = "";
  const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

  function createButton(text, disabled = false, onClick = null) {
    const btn = document.createElement("button");
    btn.textContent = text;
    if (disabled) {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";
    }
    if (onClick) btn.addEventListener("click", onClick);
    return btn;
  }

  paginationDiv.appendChild(createButton("Previous", currentPage === 1, () => { currentPage--; renderTransactionsPage(); }));

  for (let i = 1; i <= totalPages; i++) {
    const pageBtn = createButton(i, false, () => { currentPage = i; renderTransactionsPage(); });
    if (i === currentPage) pageBtn.classList.add("active");
    paginationDiv.appendChild(pageBtn);
  }

  paginationDiv.appendChild(createButton("Next", currentPage === totalPages, () => { currentPage++; renderTransactionsPage(); }));
}

// ------------------------
// Initialize all on page load
// ------------------------
window.addEventListener("DOMContentLoaded", () => {
  loadTodaysSales();
  loadLowStockAlerts();
  loadRecentTransactions();
  loadSalesTrend("daily"); // default
});

// ------------------------
// Sales Trend Chart (Completed Only)
// ------------------------
let salesChart; // global so we can destroy old chart

// ------------------------
// Sales Trend Chart with Moving Gradient Line
// ------------------------
async function loadSalesTrend(period = "daily") {
  const ctx = document.getElementById("salesTrendChart").getContext("2d");

  try {
    const res = await fetch(`/sales/trend?period=${period}`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    const labels = data.map(d => d._id);
    const totals = data.map(d => d.totalSales);

    if (salesChart) salesChart.destroy();

    let gradientOffset = 0; // for animation

    // Plugin to create moving gradient
    const movingGradientPlugin = {
      id: 'movingGradient',
      beforeDatasetDraw: (chart) => {
        const dataset = chart.data.datasets[0];
        const ctx = chart.ctx;
        const { left, right } = chart.chartArea;

        const gradient = ctx.createLinearGradient(left, 0, right, 0);
        gradient.addColorStop((0 + gradientOffset) % 1, "#00bfff");
        gradient.addColorStop((0.25 + gradientOffset) % 1, "#1e90ff");
        gradient.addColorStop((0.5 + gradientOffset) % 1, "#4169e1");
        gradient.addColorStop((0.75 + gradientOffset) % 1, "#1e90ff");
        gradient.addColorStop((1 + gradientOffset) % 1, "#00bfff");

        dataset.borderColor = gradient;
        gradientOffset += 0.002; // slower speed for smooth animation
      }
    };

salesChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: labels, // keep the raw date strings
    datasets: [{
      data: totals,
      borderColor: "#00bfff", // initial color
      backgroundColor: "transparent",
      tension: 0.3,
      fill: false,
      pointRadius: 5,
      pointBackgroundColor: "#fff",
      pointBorderColor: "#00bfff",
      borderWidth: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 0 }, // manual animation
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: true,
        callbacks: {
          label: (ctx) => `â‚±${ctx.raw.toLocaleString()}`
        }
      }
    },
    scales: {
      x: {
        ticks: {
          callback: function(value, index) {
            const date = new Date(this.getLabelForValue(index));
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'short' }); // e.g., "Oct"
            return `${day} ${month}`; // outputs "21 Oct"
          }
        }
      },
      y: {
        beginAtZero: true,
        ticks: { callback: v => `â‚±${v.toLocaleString()}` }
      }
    }
  },
  plugins: [movingGradientPlugin]
});

    // Animation loop
    function animate() {
      salesChart.update('none'); // update without built-in animation
      requestAnimationFrame(animate);
    }
    animate();

  } catch (err) {
    console.error("Failed to load sales trend:", err);
  }
}

// ------------------------
// Hook up Daily/Weekly/Monthly buttons
// ------------------------
document.querySelectorAll(".trend .btn-group .btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".trend .btn-group .btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    loadSalesTrend(btn.textContent.toLowerCase());
  });
});


const detailModal = document.getElementById("transactionDetailModal");
const modalBody = document.getElementById("modalBody");
const closeBtn = detailModal.querySelector(".close");

// Open modal on eye icon click
document.getElementById("transactions-body").addEventListener("click", (e) => {
  if (e.target.classList.contains("fa-eye")) {
    const row = e.target.closest("tr");
    if (!row) return;

    const txnId = row.children[0].textContent;
    const dateTime = row.children[1].textContent;
    const staff = row.children[2].textContent;
    const items = row.children[3].textContent;
    const total = row.children[4].textContent;
    const status = row.children[5].textContent;

    // Fill modal table body
    modalBody.innerHTML = `
      <tr>
        <td>${txnId}</td>
        <td>${dateTime}</td>
        <td>${staff}</td>
        <td>${items}</td>
        <td>${total}</td>
        <td><span class="status ${status.toLowerCase()}">${status}</span></td>
      </tr>
    `;

    detailModal.style.display = "block";
  }
});

// Close modal
closeBtn.addEventListener("click", () => detailModal.style.display = "none");
window.addEventListener("click", (e) => {
  if (e.target === detailModal) detailModal.style.display = "none";
});








const editModal = document.getElementById("transactionEditModal");
const editForm = document.getElementById("editTransactionForm");
const editCloseBtn = editModal.querySelector(".close");

const badgeClassMap = {
  "Completed": "paid",
  "Pending": "pending",
  "Cancelled": "cancelled"
};

let currentEditingRow = null;

// ------------------------
// Handle clicks on the transactions table
// ------------------------
document.getElementById("transactions-body").addEventListener("click", (e) => {
  const row = e.target.closest("tr");
  if (!row) return;

  // ---------- Edit ----------
  if (e.target.classList.contains("fa-pen")) {
    currentEditingRow = row;

    document.getElementById("editTxnId").textContent = row.children[0].textContent;
    document.getElementById("editTxnDate").textContent = row.children[1].textContent;
    document.getElementById("editTxnStaff").textContent = row.children[2].textContent;
    document.getElementById("editTxnItems").textContent = row.children[3].textContent;
    document.getElementById("editTxnTotal").textContent = row.children[4].textContent;

    const currentStatus = row.children[5].textContent.trim();
    document.getElementById("editTxnStatus").value = ["Pending", "Completed", "Cancelled"].includes(currentStatus)
      ? currentStatus
      : "Pending";

    editModal.style.display = "block";
    return;
  }

 if (e.target.classList.contains("fa-trash")) {
  const row = e.target.closest("tr");
  const txnId = row.dataset.id;
  if (!txnId) return alert("Transaction ID missing.");

  // Show popup
  const popup = document.getElementById("deletePopup");
  popup.classList.add("active");

  // Handle cancel
  popup.querySelector("#cancelDelete").onclick = () => {
    popup.classList.remove("active");
  };

  // Handle confirm
  popup.querySelector("#confirmDelete").onclick = async () => {
    try {
      const res = await fetch(`/transactions/${txnId}`, { method: "DELETE" });
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Delete failed");

      // Remove the row + refresh
      row.remove();
      loadTodaysSales();
      renderTransactionsPage();

      // Success mini popup
      popup.innerHTML = `
        <div class="popup-box">
          <i class="fa fa-check-circle" style="color:#27ae60;"></i>
          <h3>Deleted!</h3>
          <p>Transaction deleted successfully.</p>
        </div>
      `;
      setTimeout(() => {
        popup.classList.remove("active");
        popup.innerHTML = `
          <div class="popup-box">
            <i class="fa fa-exclamation-triangle"></i>
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this transaction?</p>
            <div class="popup-buttons">
              <button id="confirmDelete">Delete</button>
              <button id="cancelDelete">Cancel</button>
            </div>
          </div>
        `;
      }, 1500);

    } catch (err) {
      console.error("Failed to delete transaction:", err);
      alert("Failed to delete transaction. Please try again.");
      popup.classList.remove("active");
    }
  };
}




  // ---------- View (eye icon) ----------
  if (e.target.classList.contains("fa-eye")) {
    document.getElementById("modalBody").innerHTML = `
      <tr>
        <td>${row.children[0].textContent}</td>
        <td>${row.children[1].textContent}</td>
        <td>${row.children[2].textContent}</td>
        <td>${row.children[3].textContent}</td>
        <td>${row.children[4].textContent}</td>
        <td><span class="status ${row.children[5].textContent.toLowerCase()}">${row.children[5].textContent}</span></td>
      </tr>
    `;
    document.getElementById("transactionDetailModal").style.display = "block";
  }
});

// ------------------------
// Close modals
// ------------------------
editCloseBtn.addEventListener("click", () => editModal.style.display = "none");
window.addEventListener("click", (e) => {
  if (e.target === editModal) editModal.style.display = "none";
  if (e.target === document.getElementById("transactionDetailModal")) {
    document.getElementById("transactionDetailModal").style.display = "none";
  }
});

// ------------------------
// Submit edit form
// ------------------------
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentEditingRow) return;

  const txnId = currentEditingRow.dataset.id; 
  const newStatus = document.getElementById("editTxnStatus").value;

  try {
    const res = await fetch(`/transactions/${txnId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus })
    });

    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.message || "Update failed");

    // Update status badge
    const badgeClass = badgeClassMap[newStatus] || "pending";
    currentEditingRow.children[5].innerHTML = `<span class="badge ${badgeClass}">${newStatus}</span>`;

    // âœ… Update action icons
    const actionsCell = currentEditingRow.children[6];
    actionsCell.innerHTML = `<i class="fa fa-eye"></i> <i class="fa fa-trash"></i>`;
    if (newStatus === "Pending") {
      actionsCell.innerHTML = `<i class="fa fa-eye"></i> <i class="fa fa-pen"></i> <i class="fa fa-trash"></i>`;
    }

    editModal.style.display = "none";
  } catch (err) {
    console.error("Failed to update transaction:", err);
    alert("Failed to update status. Please try again.");
  }
});


</script>

  
</body>
</html>
