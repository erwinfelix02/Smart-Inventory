<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Inventory</title>
  <link rel="icon" type="image/png" href="../images/logo.svg">
  <link rel="stylesheet" href="Sidebar.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <img src="../images/logo.svg" alt="Logo" class="logo-img"> 
      <div class="logo-text">
        <h2>Smart Inventory</h2>
        <small>Alert System</small>
      </div>
      <button id="collapse-btn" onclick="toggleSidebar()" class="collapse-btn">
        <img src="../images/collapse.svg" alt="Collapse Sidebar">
      </button>
      <button class="close-btn" onclick="closeSidebar()">âœ–</button>
    </div>

    <ul>
      <li id="dashboard-menu" class="active" onclick="handleDashboardMenu(this)">
        <img src="../images/dashboard.svg" alt="Dashboard Icon" class="menu-icon"> Dashboard
      </li>

      <li id="inventory-management" onclick="changePage('Inventory Management','Track and manage inventory', this, '../Contents/inventory-management.html')">
        <img src="../images/inventory.svg" alt="Inventory Icon" class="menu-icon"> Inventory Management
      </li>

      <li id="sales-menu" onclick="handleSalesMenu(this)">
        <img src="../images/sales.svg" alt="Sales Icon" class="menu-icon">
        <span id="sales-text">Sales & Transactions</span>
      </li>

      <li onclick="changePage('Alert Management','Manage system alerts and notifications', this, '../Contents/alert.html')">
        <img src="../images/alert.svg" alt="Alert Icon" class="menu-icon"> Alert Management
      </li>
      <li id="customer-transactions" onclick="changePage('Customer Transactions','Manage customer transactions', this, '../Contents/customer-transactions.html')">
        <img src="../images/transaction.png" alt="Customer Transactions Icon" class="menu-icon"> Customer Transactions
      </li>


      <li id="user-management" onclick="changePage('User Management','Manage users and roles', this, '../Contents/user-management.html')">
        <img src="../images/user.svg" alt="User Management Icon" class="menu-icon"> User Management
      </li>

      <li id="settings-menu">
        <img src="../images/settings.svg" alt="Settings Icon" class="menu-icon"> Settings
      </li>
    </ul>

    <!-- User footer -->
    <div class="user-info">
      <span class="avatar"></span>
      <div>
        <p></p>
        <small></small>
      </div>
      <button class="log-out" onclick="changeAccount()">
        <img src="../images/logout.svg" alt="Change Account">
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="topbar">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="title">
        <h2 id="page-title">Dashboard</h2>
        <p id="page-subtitle">Real-time inventory monitoring and alerts</p>
      </div>
      <div class="banner-container">
        <div class="banner-text">
          - Welcome to Smart Inventory System! | Stay updated with real-time alerts, low-stock warnings, and sales notifications! | Manage your inventory efficiently today!
        </div>
      </div>
      <div class="icons">
      <div class="bell-container" onclick="toggleBell(this)">
        <img src="../images/bell.svg" alt="Notification Bell" class="bell">
        <span class="bell-badge" id="bellBadge">0</span>

        <!--  Dropdown for alerts -->
        <div id="alertDropdown" class="alert-dropdown hidden">
          <h4>Recent Alerts</h4>
          <ul id="alertList"></ul>
        </div>
      </div>

    </div>

    </div>

    <div id="page-content">
      <iframe id="content-frame" src="" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>

  <script>
    // --- Get user from localStorage ---
    const userData = localStorage.getItem("user");
    let user = null;

    if (userData) {
      try { user = JSON.parse(userData); } 
      catch(e) { console.error("Error parsing user data:", e); }
    }

    // --- Display user info ---
    const userNameEl = document.querySelector(".user-info p");
    const userRoleEl = document.querySelector(".user-info small");
    const avatarEl = document.querySelector(".user-info .avatar");

    userNameEl.innerText = user?.fullName || "Guest";
    userRoleEl.innerText = user?.role || "Unknown";
    avatarEl.innerText = user?.fullName 
      ? user.fullName.split(" ").map(n => n[0]).join("").toUpperCase()
      : "?";

    // --- Hide User Management for non-admin/manager ---
    const userManagementMenu = document.getElementById("user-management");
    if (userManagementMenu) {
      const role = user?.role?.toLowerCase();
      if (role !== "admin" && role !== "manager") userManagementMenu.style.display = "none";
    }

    // --- Set Sales & Transactions label based on role ---
    const salesMenu = document.getElementById("sales-menu");
    if (salesMenu) {
      const span = salesMenu.querySelector("span") || document.createElement("span");
      const role = user?.role?.toLowerCase();
      span.textContent = (role === "admin" || role === "manager") ? "Sales" :
                         (role === "staff") ? "Transactions" : "Sales & Transactions";
      if (!salesMenu.querySelector("span")) salesMenu.appendChild(span);
    }

    // --- Role-based dashboard ---
    function getDashboardFile() {
      const role = user?.role?.toLowerCase();
      if (role === "staff") return { file: "../Contents/staff-dashboard.html", title: "Staff Dashboard", subtitle: "Track your transactions and performance" };
      return { file: "../Contents/dashboard.html", title: "Dashboard", subtitle: "Real-time inventory monitoring and alerts" };
    }

    const { file: dashboardFile, title: dashboardTitle, subtitle: dashboardSubtitle } = getDashboardFile();

    // --- Load initial dashboard ---
    const iframe = document.getElementById("content-frame");
    iframe.src = dashboardFile;
    document.getElementById("page-title").innerText = dashboardTitle;
    document.getElementById("page-subtitle").innerText = dashboardSubtitle;

    // --- Change page function ---
    function changePage(title, subtitle, element, file) {
      document.getElementById("page-title").innerText = title;
      document.getElementById("page-subtitle").innerText = subtitle;
      iframe.src = file;
      document.querySelectorAll(".sidebar ul li").forEach(li => li.classList.remove("active"));
      if (element) element.classList.add("active");
      if (window.innerWidth < 768) closeSidebar();
    }

    // --- Dashboard menu click ---
    function handleDashboardMenu(element) {
      const { file, title, subtitle } = getDashboardFile();
      changePage(title, subtitle, element, file);
    }

    // --- Sales menu click ---
    function handleSalesMenu(element) {
      const role = user?.role?.toLowerCase();
      let file, title, subtitle;

      if (role === "admin" || role === "manager") {
        file = "../Contents/admin-manager-sales-and-transaction.html";
        title = "Sales";
        subtitle = "Monitor sales and transactions (Admin/Manager)";
      } else if (role === "staff") {
        file = "../Contents/staff-sales-and-transaction.html";
        title = "Transactions";
        subtitle = "Monitor sales and transactions (Staff)";
      } else {
        alert("You do not have access to Sales & Transactions.");
        return;
      }
      changePage(title, subtitle, element, file);
    }

    // --- Settings menu click ---
    const settingsMenu = document.getElementById("settings-menu");
    if (settingsMenu) {
      settingsMenu.onclick = function() {
        const role = user?.role?.toLowerCase();
        const file = (role === "admin") ? "system-settings.html" : "profile-settings.html";
        const title = (role === "admin") ? "System Settings" : "Profile Settings";
        const subtitle = (role === "admin") ? "Manage business settings and preferences" : "Manage your account settings";
        changePage(title, subtitle, settingsMenu, file);
      };
    }

    // --- Sidebar toggle ---
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const collapseBtnImg = document.querySelector("#collapse-btn img");
      sidebar.classList.toggle("collapsed");
      collapseBtnImg.style.transform = sidebar.classList.contains("collapsed") ? "rotate(180deg)" : "rotate(0deg)";
    }
    function closeSidebar() {
      document.getElementById("sidebar").classList.remove("open");
    }
    window.addEventListener("resize", () => { if (window.innerWidth >= 768) closeSidebar(); });

    // --- Logout ---
    function changeAccount() {
      localStorage.removeItem("user");
      window.location.href = "../Landing Page/signin.html";
    }



   function toggleBell(element) {
  if (!element) return;
  element.classList.toggle("active");

  const dropdown = document.getElementById("alertDropdown");
  dropdown.classList.toggle("hidden");
}

async function fetchAlerts() {
  try {
    const res = await fetch("http://localhost:3000/alert");
    if (!res.ok) throw new Error("Failed to fetch alerts");

    const alerts = await res.json();
    const activeAlerts = alerts.filter(alert => Number(alert.stock) <= 10);
    const badge = document.getElementById("bellBadge");
    const alertList = document.getElementById("alertList");

    // Update badge count
    const totalCount = activeAlerts.length;
    badge.textContent = totalCount;
    badge.style.display = totalCount > 0 ? "flex" : "none";

    // Update dropdown list
    alertList.innerHTML = "";
    if (activeAlerts.length === 0) {
      alertList.innerHTML = `<li style="text-align:center;color:#777;">No active alerts</li>`;
    } else {
      activeAlerts.forEach(a => {
        const li = document.createElement("li");
        li.className = a.severity === "Critical" ? "critical" : "";
        li.innerHTML = `
          <span>${a.name}</span>
          <small>${a.type}</small>
        `;
        alertList.appendChild(li);
      });
    }

    console.log("ðŸŽ¯ Active alerts:", activeAlerts);
  } catch (err) {
    console.error("âŒ Error fetching alerts:", err);
  }
}

fetchAlerts();
setInterval(fetchAlerts, 30000);

// Click outside to close the alert dropdown
document.addEventListener("click", (event) => {
  const bellContainer = document.querySelector(".bell-container");
  const dropdown = document.getElementById("alertDropdown");

  // If click is NOT inside the bell container or the dropdown, hide dropdown
  if (!bellContainer.contains(event.target) && !dropdown.contains(event.target)) {
    bellContainer.classList.remove("active");
    dropdown.classList.add("hidden");
  }
});


  </script>
</body>
</html>
