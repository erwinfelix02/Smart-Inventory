<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <div class="dashboard">

    <!-- TOP SECTION -->
    <div class="top-section">
      <div class="left-side">
        <!-- SUMMARY CARDS -->
        <div class="summary-section">
          <div class="summary-card total">
            <div class="summary-info">
              <p>Total Products</p>
              <h2>1,247</h2>
              <small>All Products</small>
            </div>
            <div class="summary-icon"><img src="../images/inventory.svg" alt="Total"></div>
          </div>

          <div class="summary-card low-stock">
            <div class="summary-info">
              <p>Low Stock Items</p>
              <h2>142</h2>
              <small>‚ö†Ô∏è Needs attention</small>
            </div>
            <div class="summary-icon"><img src="../images/warning.svg" alt="Low Stock"></div>
          </div>

          <div class="summary-card sales">
            <div class="summary-info">
              <p>Today's Sales</p>
              <h2>‚Ç±1,247</h2>
              <small>Sales</small>
            </div>
            <div class="summary-icon"><img src="../images/money.svg" alt="Sales"></div>
          </div>

          <div class="summary-card active-alerts">
            <div class="summary-info">
              <p>Active Alerts</p>
              <h2>12</h2>
              <small>Pending review</small>
            </div>
            <div class="summary-icon"><img src="../images/bell.svg" alt="Alerts"></div>
          </div>
        </div>

        <!-- CHART + TOP PRODUCTS SIDE BY SIDE -->
        <div class="chart-products-row">
         <div class="chart-card">
  <h3>Recent Alerts</h3>
  <canvas id="alertsChart" width="400" height="150"></canvas>
</div>


          <div class="top-products">
            <h3>Top Selling Products</h3>
            <div class="product-item">
              <div class="product-left">
                <div class="product-icon"></div>
                <span>Product A</span>
              </div>
              <span>100 sold</span>
            </div>
            <div class="product-item">
              <div class="product-left">
                <div class="product-icon"></div>
                <span>Product B</span>
              </div>
              <span>95 sold</span>
            </div>
            <div class="product-item">
              <div class="product-left">
                <div class="product-icon"></div>
                <span>Product C</span>
              </div>
              <span>89 sold</span>
            </div>
          </div>
        </div>
      </div>

<!-- RIGHT PANEL -->
<div class="right-panel">
  <h3>Recent Alerts</h3>
  
  <!-- Scrollable alerts -->
  <div class="alerts-list">
    <div class="alert-item">
      <div class="dot blue"></div>
      <div>
        <p><strong>Low Stock Alert!</strong></p>
        <small>Product A is running low (5 units left)</small><br>
        <small>2 hours ago</small>
      </div>
    </div>

    <div class="alert-item">
      <div class="dot green"></div>
      <div>
        <p><strong>Restock Complete</strong></p>
        <small>Product B restocked with 10 units</small><br>
        <small>4 hours ago</small>
      </div>
    </div>
  </div>

  <!-- Non-scrollable actions below -->
  <h4 class="quick-title">Quick Actions</h4>
  <div class="button-row">
    <button class="btn add" id="add-product">
      <img src="../images/add.svg" class="btn-icon"> Add New Product
    </button>
    <button class="btn add" id="add-user">
      <img src="../images/adduser.svg" class="btn-icon"> Add New User
    </button>
    <button class="btn add" id="export-data">
      <img src="../images/export.svg" class="btn-icon"> Export Report
    </button>
  </div>

  <button class="btn settings">
    <img src="../images/settings.svg" alt="Settings" class="btn-icon">
    Alert Settings
  </button>
</div>



  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // üß© Get user object from localStorage (used by sidebar)
  const userData = localStorage.getItem("user");
  let role = "";

  if (userData) {
    try {
      const user = JSON.parse(userData);
      role = (user.role || "").trim().toLowerCase();
    } catch (e) {
      console.error("‚ùå Error parsing user data:", e);
    }
  }

  console.log("üéØ Detected role:", role);

  // üéØ Get dashboard buttons
  const addUserBtn = document.getElementById("add-user");
  const addProductBtn = document.getElementById("add-product");
  const exportDataBtn = document.getElementById("export-data");
  const alertSettingsBtn = document.querySelector(".btn.settings");

  // üîí Disable button completely and show üö´ cursor
  const disableButton = (btn, message) => {
    if (!btn) return;
    btn.classList.add("locked");
    btn.title = message;
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.style.cursor = "not-allowed";
  };

  // üß≠ Helper: open page and highlight sidebar item
  const doc = parent?.document || document;
  const pageChanger = parent?.changePage || window.changePage;

  function openPage(title, subtitle, file) {
    if (pageChanger) {
      pageChanger(title, subtitle, null, file);
      const sidebarItems = doc.querySelectorAll("li[onclick*='changePage']");
      sidebarItems.forEach((li) => {
        const match = li.getAttribute("onclick").includes(file);
        li.classList.toggle("active", match);
      });
    } else {
      console.warn("‚ö†Ô∏è changePage() not found");
    }
  }

  // ===============================
  // üß∑ ROLE PERMISSIONS LOGIC
  // ===============================
  // Replace your current exportDataBtn listener with this:
if (role.includes("admin")) {
  const exportDataBtn = document.getElementById("export-data");
  if (exportDataBtn) {
    exportDataBtn.addEventListener("click", async () => {
      try {
        // Fetch the Excel file as a blob
        const res = await fetch("/live-export");
        if (!res.ok) throw new Error("Failed to fetch live export");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Create a temporary link to trigger download
        const a = document.createElement("a");
        a.href = url;
        a.download = "live_export_report.xlsx"; // filename for Tableau
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);

        alert("‚úÖ Excel downloaded! Open it in Tableau.");
      } catch (err) {
        console.error("‚ùå Failed to export Excel:", err);
        alert("Failed to export Excel. Check console for details.");
      }
    });
  }
}
 else if (role.includes("manager")) {
    console.log("‚ö†Ô∏è Manager detected: Export disabled");
    disableButton(exportDataBtn, "Managers cannot export reports");
  } else {
    console.log("üë§ Other role detected: Export disabled");
    disableButton(exportDataBtn, "You do not have permission to export data");
  }

  // ===============================
  // üåç COMMON BUTTONS (All Roles)
  // ===============================
  if (addUserBtn) {
    addUserBtn.addEventListener("click", () =>
      openPage("User Management", "Manage users and roles", "../Contents/user-management.html")
    );
  }

  if (addProductBtn) {
    addProductBtn.addEventListener("click", () =>
      openPage("Inventory Management", "Track and manage inventory", "../Contents/inventory-management.html")
    );
  }

  if (alertSettingsBtn) {
    alertSettingsBtn.addEventListener("click", () =>
      openPage("Alert Management", "Manage system alerts and notifications", "../Contents/alert.html")
    );
  }
});





// Fetch all available products
fetch("/products/available")
  .then(res => res.json())
  .then(products => {
    console.log("üì¶ Available products:", products);
    // You can render them on the page
  })
  .catch(err => console.error("‚ùå Failed to fetch available products:", err));

// ‚ö†Ô∏è Load Low-Stock Products
fetch("/products")
  .then(res => res.json())
  .then(products => {
    const lowStockElem = document.querySelector(".summary-card.low-stock h2");
    const settingsRes = fetch("/system-settings").then(r => r.json());

    Promise.all([products, settingsRes]).then(([products, settings]) => {
      const critical = settings.critical_stock_threshold ?? 10;
      const low = settings.low_stock_threshold ?? 15;

      // Count products that are low stock (above critical, but below or equal low threshold)
      const lowStockCount = products.filter(p => p.stock > critical && p.stock <= low).length;

      if (lowStockElem) lowStockElem.textContent = lowStockCount;
    });
  })
  .catch(err => console.error("‚ùå Failed to fetch low stock count:", err));


// üßæ Fetch all products and compute total stock dynamically
fetch("/products")
  .then(res => res.json())
  .then(products => {
    console.log("All products:", products);

    // Compute total stock
    const totalStock = products.reduce((sum, p) => sum + (p.stock || 0), 0);

    // Update Total Products card
    const totalElem = document.querySelector(".summary-card.total h2");
    if (totalElem) totalElem.textContent = totalStock;
  })
  .catch(err => console.error("‚ùå Failed to fetch products:", err));


  // üßæ Fetch today's completed sales
fetch("/transactions")
  .then(res => res.json())
  .then(data => {
    const transactions = data.transactions || data; // handle your route returning just array or object

    // Get today's date boundaries
    const start = new Date();
    start.setHours(0, 0, 0, 0);
    const end = new Date();
    end.setHours(23, 59, 59, 999);

    // Filter for completed transactions today
    const todaysSales = transactions.filter(txn => {
      const txnDate = new Date(txn.date);
      return txn.status === "Completed" && txnDate >= start && txnDate <= end;
    });

    // Sum totals
    const totalSales = todaysSales.reduce((sum, txn) => sum + (txn.total || 0), 0);

    // Update the card
    const salesElem = document.querySelector(".summary-card.sales h2");
    if (salesElem) salesElem.textContent = `‚Ç±${totalSales.toLocaleString()}`;
  })
  .catch(err => console.error("‚ùå Failed to fetch today's sales:", err));

// üßæ Fetch today's completed sales grouped by product
fetch("/transactions")
  .then(res => res.json())
  .then(data => {
    const transactions = data.transactions || data; // handle object/array

    // Filter only completed transactions
    const completedTxns = transactions.filter(txn => txn.status === "Completed");

    // Aggregate by product
    const productSales = {};
    let totalSold = 0; // total count of products sold
    completedTxns.forEach(txn => {
      const name = txn.product?.name || "Unknown Product";
      const qty = txn.quantity || 0;

      totalSold += qty;

      if (productSales[name]) {
        productSales[name] += qty;
      } else {
        productSales[name] = qty;
      }
    });

    // Convert to array and sort descending by quantity
    const topProducts = Object.entries(productSales)
      .map(([name, qty]) => ({ name, qty }))
      .sort((a, b) => b.qty - a.qty)
      .slice(0, 3); // top 3 products

    // Render into dashboard
    const topProductsContainer = document.querySelector(".top-products");
    if (topProductsContainer) {
      // Clear existing items except header
      topProductsContainer.querySelectorAll(".product-item").forEach(el => el.remove());

      topProducts.forEach(product => {
        const div = document.createElement("div");
        div.classList.add("product-item");

        div.innerHTML = `
          <div class="product-left">
            <div class="product-icon"></div>
            <span>${product.name}</span>
          </div>
          <span>${product.qty} sold</span>
        `;

        topProductsContainer.appendChild(div);
      });
    }
  })
  .catch(err => console.error("‚ùå Failed to fetch top selling products:", err));



// Call on page load
document.addEventListener("DOMContentLoaded", loadDashboardAlerts);




let alertsChart; // store chart instance globally

async function loadDashboardAlerts() {
  try {
    // 1Ô∏è‚É£ Fetch products and system thresholds
    const [productsRes, settingsRes] = await Promise.all([
      fetch("http://localhost:3000/products"),
      fetch("http://localhost:3000/system-settings")
    ]);
    const products = await productsRes.json();
    const settings = await settingsRes.json();

    const thresholds = {
      critical: settings.critical_stock_threshold ?? 0,
      low: settings.low_stock_threshold ?? 5,
      warning: settings.warning_stock_threshold ?? 10
    };

    // 2Ô∏è‚É£ Generate alerts for products under warning
    const alerts = products
      .filter(p => p.stock <= thresholds.warning)
      .map(p => ({
        name: p.name,
        stock: p.stock,
        createdAt: p.updatedAt || p.createdAt || new Date()
      }));

    // 3Ô∏è‚É£ Save alerts to DB (optional)
    for (const alert of alerts) {
      await fetch("http://localhost:3000/stored-alerts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...alert, status: "New" })
      });
    }

    // 4Ô∏è‚É£ Render Recent Alerts
    const container = document.querySelector(".right-panel .alerts-list");
    const activeAlertsCountElem = document.querySelector(".summary-card.active-alerts h2");
    if (!container) return;

    container.innerHTML = "";

alerts
  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
  .forEach(alert => {
    // Determine severity based on thresholds
    const severity = getSeverity(alert.stock, thresholds);

    // Map severity to color and title
    const config = severityConfig[severity];

    // Create alert item div
    const div = document.createElement("div");
    div.classList.add("alert-item");
    div.innerHTML = `
      <div class="dot ${config.color}"></div>
      <div>
        <p><strong>${config.title}</strong></p>
        <small>${alert.name} ${severity === "Out-of-stock" ? "is out of stock" : `has ${alert.stock} units left`}</small><br>
        <small>${new Date(alert.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
      </div>
    `;
    container.appendChild(div);
  });


    // 5Ô∏è‚É£ Update Active Alerts Count
    if (activeAlertsCountElem) activeAlertsCountElem.textContent = alerts.length;

    // 6Ô∏è‚É£ Update Chart (last 7 days)
    const days = [];
    const counts = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      days.push(date.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" }));
      const count = alerts.filter(a => new Date(a.createdAt).toDateString() === date.toDateString()).length;
      counts.push(count);
    }

    const ctx = document.getElementById("alertsChart").getContext("2d");
    if (alertsChart) alertsChart.destroy();
    alertsChart = new Chart(ctx, {
      type: "line",
      data: { labels: days, datasets: [{ label: "Number of Alerts", data: counts, fill: false, borderColor: "#3498db", tension: 0.3, pointBackgroundColor: "#3498db", pointRadius: 5 }] },
      options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: "Alerts in the Last 7 Days" } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });

  } catch (err) {
    console.error("‚ùå Failed to load dashboard alerts:", err);
  }
}
function getSeverity(stock, thresholds) {
  if (stock === 0) return "Out-of-stock";
  if (stock <= thresholds.critical) return "Critical";
  if (stock <= thresholds.low) return "Low-stock";
  if (stock <= thresholds.warning) return "Warning";
  return "Normal"; // optional fallback
}
const severityConfig = {
  "Out-of-stock": { color: "red", title: "No Stock Alert!" },
  "Critical": { color: "orange", title: "Critical Stock Alert!" },
  "Low-stock": { color: "yellow", title: "Low Stock Alert!" },
  "Warning": { color: "blue", title: "Warning Stock Alert!" }
};




</script>

</body>
</html>
