<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Settings</title>
  <link rel="stylesheet" href="system-settings.css">
</head>
<body>
  <div class="content">

    <!-- 🔹 Top Row -->
    <div class="top-row">

      <!-- General Settings -->
      <div class="card dark general-card">
        <h3>General</h3>
        <div class="general-body">
          <!-- Business Information -->
          <div class="sub-card">
            <h4>Business Information</h4>
            <div class="form-group">
              <label>Business Name</label>
              <input type="text" name="business_name" value="TechCorp Solution">
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" name="address" placeholder="Enter address">
            </div>  
          </div>

          <!-- Regional Settings -->
          <div class="sub-card">
            <h4>Regional Settings</h4>
            
        <div class="form-group">
            <label>Currency</label>
            <select name="currency">
              <option value="USD">USD ($)</option>
              <option value="PHP">PHP (₱)</option>
              <option value="EUR">EUR (€)</option>
            </select>
          </div>
            <div class="form-group">
              <label>Language</label>
              <select name="language">
                <option value="English">English</option>
                <option value="Filipino">Filipino</option>
                <option value="Spanish">Spanish</option>
              </select>
            </div>
          </div>
        </div>

        <div class="save-btn-container">
  <button class="btn cancel" id="cancelBtn" style="display:none;">Cancel</button>
  <button class="btn save" id="saveBtn" style="display:none;">Save Changes</button>
  <button class="btn edit" id="editBtn">Edit</button>
</div>

      </div>

      <!-- Alert Recipients -->
      <!-- Alert Recipients -->
<div class="card alert-card">
  <h3>Alert Recipients</h3>
  <div class="form-group">
    <label>Low Stock Threshold</label>
    <input type="number" name="low_stock_threshold" value="10">
  </div>
  <div class="form-group">
    <label>Critical Stock Threshold</label>
    <input type="number" name="critical_stock_threshold" value="10">
  </div>
  <div class="form-group">
    <label>Warning Stock Threshold</label>
    <input type="number" name="warning_stock_threshold" value="10">
  </div>
  <div class="form-group">
    <label>Notification Recipients</label>
    <div class="checkbox-group">
  <label>All Admins <input type="checkbox"></label>
  <label>Inventory Managers <input type="checkbox"></label>
  <label>Sales Staff <input type="checkbox"></label>
</div>

  </div>

  <!-- New Button Set for Alerts -->
  <div class="save-btn-container">
    <button class="btn cancel" id="cancelAlertBtn" style="display:none;">Cancel</button>
    <button class="btn save" id="saveAlertBtn" style="display:none;">Save Changes</button>
    <button class="btn edit" id="editAlertBtn">Edit</button>
  </div>
</div>

    </div>

    <!-- 🔹 Bottom Row -->
    <div class="bottom-row">
      <!-- Roles & Permissions -->
      <div class="card roles-card">
        <h3>Roles & Permissions</h3>
        <p class="desc">Manage access for Admin, Manager, Staff.</p>
       <button class="btn primary" id="btnUserManagement"
  onclick="goToUserManagement()">
  Go to User Management
</button>
      </div>

      <!-- System Logs -->
      <div class="card logs-card">
        <h3>System Logs</h3>
        <p class="desc">Recent system activities</p>
        <div class="logs-container">
          <table class="logs-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Action</th>
                <th>User</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2024-01-15</td>
                <td>Login</td>
                <td>admin@company.com</td>
                <td class="status success">Success</td>
              </tr>
              <tr>
                <td>2024-01-15</td>
                <td>Update Item</td>
                <td>manager@company.com</td>
                <td class="status success">Success</td>
              </tr>
              <tr>
                <td>2024-01-16</td>
                <td>Delete Item</td>
                <td>staff@company.com</td>
                <td class="status failed">Failed</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Save Status Message -->
<div id="saveStatus"></div>

 <script>
// ============================
// NAVIGATION FUNCTION
// ============================
function goToUserManagement() {
  const sidebarItem = parent.document.querySelector("li[onclick*='user-management.html']");
  if (sidebarItem && parent.changePage) {
    parent.changePage(
      'User Management',
      'Manage users and roles',
      sidebarItem,
      'user-management.html'
    );
  }
}

// ============================
// GENERAL SETTINGS SECTION
// ============================
const editBtn = document.getElementById('editBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');

const generalInputs = [
  ...document.querySelectorAll('.general-card input, .general-card select')
];

let generalOriginalValues = [];

// Disable all general inputs initially
function disableGeneralInputs() {
  generalInputs.forEach(input => {
    input.setAttribute('disabled', true);
    if (input.type !== 'checkbox') input.style.cursor = 'not-allowed';
  });
}

// Enable general inputs
function enableGeneralInputs() {
  generalInputs.forEach(input => {
    input.removeAttribute('disabled');
    if (input.type !== 'checkbox') input.style.cursor = 'text';
  });
}

// Load settings from backend
async function loadSettings() {
  disableGeneralInputs();
  disableAlertInputs();

  try {
    const response = await fetch("/system-settings");
    if (!response.ok) throw new Error("Failed to fetch settings");

    const data = await response.json();
    console.log("Loaded settings:", data);

    // Populate General Settings
    const generalFields = [
      ["input[name='business_name']", data.business_name || ""],
      ["input[name='address']", data.address || ""],
      ["select[name='currency']", data.currency || "PHP"],
      ["select[name='language']", data.language || "English"]
    ];

    generalFields.forEach(([selector, value]) => {
      const el = document.querySelector(selector);
      if (el) el.value = value;
    });

    // Populate Alert Settings
    const alertFields = [
      ["input[name='low_stock_threshold']", data.low_stock_threshold ?? 10],
      ["input[name='critical_stock_threshold']", data.critical_stock_threshold ?? 10],
      ["input[name='warning_stock_threshold']", data.warning_stock_threshold ?? 10]
    ];

    alertFields.forEach(([selector, value]) => {
      const el = document.querySelector(selector);
      if (el) el.value = value;
    });

    // Populate recipients checkboxes
    document.querySelectorAll('.alert-card input[type="checkbox"]').forEach(cb => {
      const label = cb.parentNode.textContent.trim();
      cb.checked = (data.recipients || []).includes(label);
    });

    // Store original values
    generalOriginalValues = generalInputs.map(input => input.value);
    alertOriginalValues = alertInputs.map(input =>
      input.type === 'checkbox' ? input.checked : input.value
    );

  } catch (err) {
    console.error("❌ Error loading settings:", err);
   showStatusMessage(result.message || "Failed to Update!");

  }
}

window.addEventListener("DOMContentLoaded", () => {
  loadSettings();
  loadSystemLogs(); // <-- fetch logs when page loads
});


// Edit General
editBtn?.addEventListener('click', () => {
  enableGeneralInputs();
  editBtn.style.display = 'none';
  saveBtn.style.display = 'inline-block';
  cancelBtn.style.display = 'inline-block';
});

// Cancel General
cancelBtn?.addEventListener('click', () => {
  generalInputs.forEach((input, i) => {
    input.value = generalOriginalValues[i];
  });
  disableGeneralInputs();
  editBtn.style.display = 'inline-block';
  saveBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
});

// Save General
saveBtn?.addEventListener('click', async () => {
  const data = {
    business_name: document.querySelector("input[name='business_name']")?.value || "",
    address: document.querySelector("input[name='address']")?.value || "",
    currency: document.querySelector("select[name='currency']")?.value || "PHP",
    language: document.querySelector("select[name='language']")?.value || "English"
  };
 
  try {
    const result = await updateSettings(data); // <-- call the helper


    generalOriginalValues = generalInputs.map(input => input.value);
    disableGeneralInputs();
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';

    showStatusMessage(result.message || "General settings saved successfully!");

  } catch (err) {
    console.error("❌ Error saving general settings:", err);
  showStatusMessage("Failed to save general settings. Try again.", true);


  }
});

// ============================
// ALERT RECIPIENTS SECTION
// ============================
const editAlertBtn = document.getElementById('editAlertBtn');
const saveAlertBtn = document.getElementById('saveAlertBtn');
const cancelAlertBtn = document.getElementById('cancelAlertBtn');

const alertInputs = [
  ...document.querySelectorAll('.alert-card input[type="number"], .alert-card input[type="checkbox"]')
];
let alertOriginalValues = [];

// Disable all alert inputs initially
function disableAlertInputs() {
  alertInputs.forEach(input => {
    input.setAttribute('disabled', true);
    if (input.type !== 'checkbox') input.style.cursor = 'not-allowed';
  });
}

// Enable alert inputs
function enableAlertInputs() {
  alertInputs.forEach(input => {
    input.removeAttribute('disabled');
    if (input.type !== 'checkbox') input.style.cursor = 'text';
  });
}

// Edit Alert
editAlertBtn?.addEventListener('click', () => {
  enableAlertInputs();
  editAlertBtn.style.display = 'none';
  saveAlertBtn.style.display = 'inline-block';
  cancelAlertBtn.style.display = 'inline-block';

  alertOriginalValues = alertInputs.map(input =>
    input.type === 'checkbox' ? input.checked : input.value
  );
});

// Cancel Alert
cancelAlertBtn?.addEventListener('click', () => {
  alertInputs.forEach((input, i) => {
    if (input.type === 'checkbox') input.checked = alertOriginalValues[i];
    else input.value = alertOriginalValues[i];
  });

  disableAlertInputs();
  editAlertBtn.style.display = 'inline-block';
  saveAlertBtn.style.display = 'none';
  cancelAlertBtn.style.display = 'none';
});

// Save Alert
saveAlertBtn?.addEventListener('click', async () => {
  const data = {
    low_stock_threshold: Number(document.querySelector("input[name='low_stock_threshold']")?.value ?? 10),
    critical_stock_threshold: Number(document.querySelector("input[name='critical_stock_threshold']")?.value ?? 10),
    warning_stock_threshold: Number(document.querySelector("input[name='warning_stock_threshold']")?.value ?? 10),
    recipients: Array.from(document.querySelectorAll('.alert-card input[type="checkbox"]:checked'))
      .map(cb => cb.parentNode.textContent.trim())
  };
 
  try {
    const response = await fetch("/system-settings/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (!response.ok) throw new Error("Failed to save alert settings");
    const result = await response.json();

    alertOriginalValues = alertInputs.map(input =>
      input.type === 'checkbox' ? input.checked : input.value
    );

    disableAlertInputs();
    editAlertBtn.style.display = 'inline-block';
    saveAlertBtn.style.display = 'none';
    cancelAlertBtn.style.display = 'none';

    showStatusMessage(result.message || "Alert settings saved successfully!");

  } catch (err) {
    console.error("❌ Error saving alert settings:", err);
    showStatusMessage("Failed to save alert settings. Try again.", true);

  }
});
// ============================
// CENTER STATUS MESSAGE
// ============================
function showStatusMessage(message, isError = false) {
  const status = document.getElementById('saveStatus');
  status.textContent = message;
  status.classList.add('show');
  status.classList.toggle('error', isError);

  // Hide after 2.5 seconds
  setTimeout(() => {
    status.classList.remove('show', 'error');
  }, 2500);
}



// ============================
// LOAD SYSTEM LOGS
// ============================
async function loadSystemLogs() {
  try {
    const response = await fetch("/system-settings/logs"); // use the route we added in backend
    if (!response.ok) throw new Error("Failed to fetch system logs");

    const logs = await response.json();
    const tbody = document.querySelector(".logs-table tbody");
    tbody.innerHTML = ""; // clear existing rows

    logs.forEach(log => {
      const tr = document.createElement("tr");

      const dateTd = document.createElement("td");
      const options = { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric'
      };

dateTd.textContent = new Date(log.date).toLocaleDateString('en-US', options);

      tr.appendChild(dateTd);

      const actionTd = document.createElement("td");
      const actionText = log.action || "Login";
      actionTd.textContent = actionText.charAt(0).toUpperCase() + actionText.slice(1);

      tr.appendChild(actionTd);

      const userTd = document.createElement("td");
      userTd.textContent = log.email;
      tr.appendChild(userTd);

      const statusTd = document.createElement("td");
      statusTd.textContent = log.status.charAt(0).toUpperCase() + log.status.slice(1);
      statusTd.classList.add("status");
      statusTd.classList.add(log.status === "success" ? "success" : "failed");
      tr.appendChild(statusTd);

      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("❌ Error loading system logs:", err);
  }
}


// Get logged-in user from sidebar (localStorage)
const userData = localStorage.getItem("user");
let user = null;
if (userData) user = JSON.parse(userData);

// Example: sending update request
async function updateSettings(data) {
  try {
    const res = await fetch("/system-settings/update", { // use relative URL
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...data,
        userEmail: user?.email // send sidebar user email
      })
    });

    const result = await res.json();

    if (!res.ok) {
      return { message: result.error || "Failed to update settings", error: true };
    }

    return { message: result.message || "Settings updated successfully", error: false };
  } catch (err) {
    console.error(err);
    return { message: "Failed to update settings", error: true };
  }
}


</script>


</body>
</html>
