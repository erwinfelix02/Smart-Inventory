<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="inventory-management.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</head>
<body>

  
  <!-- Save Status Message -->
<div id="saveStatus"></div>
  <div class="dashboard-container">
    
    <!-- ===== Inventory Overview ===== -->
    <section class="overview">
      <h2>Inventory Overview</h2>
      <div class="overview-cards">
        <div class="overview-card total">
         <div class="icon">
         <img src="../images/total.svg" alt="Box Icon"></div>
          <div class="info">
            <h3>Total Products</h3>
            <p>1,247</p>
          </div>
        </div>

        <div class="overview-card in-stock">
          <div class="icon">
         <img src="../images/check.svg" alt="Check Icon"></div>
          <div class="info">
            <h3>In Stock</h3>
            <p>1,089</p>
          </div>
        </div>

        <div class="overview-card low-stock">
          <div class="icon">
         <img src="../images/warning.svg" alt="Warn Icon"></div>
          <div class="info">
            <h3>Low Stock</h3>
            <p>142</p>
          </div>
        </div>

        <div class="overview-card out-stock">
        <div class="icon">
         <img src="../images/wrong.svg" alt="Wrong Icon"></div>
          <div class="info">
            <h3>Out of Stock</h3>
            <p>1,089</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Product Inventory + Alerts (Side by Side) ===== -->
    <section class="main-content">
      
      <!-- Product Inventory -->
      <div class="product-inventory">
        <div class="inventory-header">
          <h3>Product Inventory</h3>
          <div class="filters">
            <div class="search-box">
              <i class="fa fa-search"></i>
              <input type="text" placeholder="Search products..." />
            </div>
            <select>
              <option>All Categories</option>
              <option>Electronics</option>
              <option>Accessories</option>
              <option>Cables</option>
            </select>
              <button class="add-btn"><i class="fa fa-plus"></i> Add Product</button>
          </div>
        </div>

        <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Product Name</th>
        <th>SKU</th>
        <th>Category</th>
        <th>Current Quantity</th>
        <th>Stock Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- dynamically loaded rows -->
    </tbody>
  </table>
</div>
      </div>
      
<!-- Low Stock Alerts -->
<div class="low-stock-alerts">
  <h3>Low Stock Alerts</h3>
  <div class="alert-scrollable">
    <!-- JS will insert .alert-item here -->
  </div>
</div>


    </section>

    <!-- ===== Charts Section ===== -->
    <section class="charts">
      <div class="chart-card">
        <h3>Stock Distribution by Category</h3>
       <div class="chart-placeholder">
          <canvas id="categoryChart"></canvas>
       </div>
      </div>

      <div class="chart-card">
        <h3>Stock Levels Trend</h3>
      <div class="chart-placeholder">
        <canvas id="stockTrendChart"></canvas>
      </div>
      </div>

    </section>
  </div>

<!-- ðŸªŸ Add / Update Stock Modal -->
<div id="addProductModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>

    <!-- ðŸ§­ Tabs -->
    <div class="modal-tabs">
      <button id="tab-update" class="active" data-target="addProductForm">Add / Update Stock</button>
      <button id="tab-add" data-target="newProductForm">Add New Product</button>
    </div>

    <!-- ðŸ§© Wrapper for both sections -->
    <div class="modal-sections-wrapper">
      <!-- ========== UPDATE STOCK FORM ========== -->
      <form id="addProductForm" class="modal-section active">
        <h3>Add or Update Stock</h3>

        <div class="form-group">
          <label>Search Product</label>
          <input type="text" id="searchProduct" placeholder="Type product name..." autocomplete="off" />
          <ul id="searchResults"></ul>
        </div>

        <hr />

        <div class="form-row">
          <div class="form-group">
            <label>Product Name</label>
            <input type="text" id="productName" readonly />
          </div>
          <div class="form-group">
            <label>Current Stock</label>
            <input type="number" id="currentStock" readonly />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>SKU</label>
            <input type="text" id="productSKU" readonly />
          </div>
          <div class="form-group">
            <label>Category</label>
            <input type="text" id="productCategory" readonly />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Add Stock</label>
            <input type="number" id="addStockAmount" min="1" placeholder="Enter quantity to add" required />
          </div>
        </div>

        <button type="submit" class="save-btn">Add Stock</button>
      </form>

      <!-- ========== ADD NEW PRODUCT FORM ========== -->
     <form id="newProductForm" class="modal-section">
  <h3>Add New Product</h3>

  <div class="form-row">
    <div class="form-group">
      <label>Product Name</label>
      <input type="text" id="newProductName" placeholder="Enter product name" required />
    </div>
   <div class="form-group">
  <label>Category</label>
  <select id="newProductCategory" required>
    <option value="" disabled selected>Select category</option>
    <option value="Accessories">Accessories</option>
    <option value="Electronics">Electronics</option>
    <option value="Cables">Cables</option>
  </select>
</div>

  </div>

  <div class="form-row">
    <div class="form-group">
      <label>Initial Stock</label>
      <input type="number" id="newProductStock" placeholder="0" min="0" required />
    </div>
    <div class="form-group">
      <label>Price</label>
      <input type="number" id="newProductPrice" placeholder="Enter price" min="0" required />
    </div>
  </div>

  <button type="submit" class="save-btn">Add Product</button>
</form>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allProducts = [];
let categoryChart;
let stockTrendChart;


// ðŸ§© Fix modal expansion issue
function updateModalHeight() {
  const wrapper = document.querySelector(".modal-sections-wrapper");
  if (!wrapper) return;

  const activeSection = wrapper.querySelector(".modal-section.active");
  if (!activeSection) return;

  // set wrapper height to active section's height
  wrapper.style.height = activeSection.scrollHeight + "px";
}

// ðŸ§© Load all products once
let settings = {}; // global

async function loadProducts() {
  try {
    // 1ï¸âƒ£ Fetch thresholds
    const settingsRes = await fetch("/system-settings");
    settings = await settingsRes.json();
    console.log("System Settings:", settings); // debug

    // 2ï¸âƒ£ Fetch products
    const productsRes = await fetch("/products");
    const products = await productsRes.json();
    allProducts = products;

    updateDashboard(products);
    displayProducts(products);
    displayLowStock(products);

    const categories = renderCategoryChart(products);
    renderStockTrendChart(products, categories);
  } catch (err) {
    console.error("Error loading data:", err);
  }
}


// ðŸ“Š Dashboard Counters
function updateDashboard(products) {
  const critical = settings.critical_stock_threshold ?? 10;
  const low = settings.low_stock_threshold ?? 15;
  const warning = settings.warning_stock_threshold ?? 30;

  const totalQuantity = products.reduce((sum, p) => sum + (p.stock || 0), 0);
  const inStock = products.filter(p => p.stock > warning).length;
  const warningStock = products.filter(p => p.stock > low && p.stock <= warning).length;
  const lowStock = products.filter(p => p.stock > critical && p.stock <= low).length;
  const outStock = products.filter(p => p.stock === 0).length;


  document.querySelector(".total p").textContent = totalQuantity;
  document.querySelector(".in-stock p").textContent = inStock;
  document.querySelector(".low-stock p").textContent = lowStock 
  document.querySelector(".out-stock p").textContent = outStock;
}




// ðŸ“‹ Product Table
function displayProducts(products) {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  const critical = settings.critical_stock_threshold;
  const low = settings.low_stock_threshold;
  const warning = settings.warning_stock_threshold;

  products.forEach(p => {
    let statusClass = "", statusText = "";

    if (p.stock === 0) {
      statusClass = "out";
      statusText = "Out of Stock";
    } else if (p.stock <= critical) {
      statusClass = "critical";
      statusText = "Critical Stock";
    } else if (p.stock <= low) {
      statusClass = "low";
      statusText = "Low Stock";
    } else if (p.stock <= warning) {
      statusClass = "warning";
      statusText = "Warning ";
    } else {
      statusClass = "normal";
      statusText = "Normal";
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.sku || "-"}</td>
      <td>${p.category || "Uncategorized"}</td>
      <td>${p.stock}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(tr);
  });
}




// ðŸš¨ Low Stock Alerts â€” only respect category filter
function displayLowStock(products) {
  const scrollable = document.querySelector(".low-stock-alerts .alert-scrollable");
  scrollable.innerHTML = "";

  const critical = settings.critical_stock_threshold;
  const low = settings.low_stock_threshold;

  const lowStockProducts = products.filter(p => p.stock > critical && p.stock <= low);

  lowStockProducts.forEach(p => {
    const div = document.createElement("div");
    div.classList.add("alert-item");
    div.innerHTML = `
      <img src="../images/exclamation.svg" class="alert-icon" alt="alert">
      <div class="details">
        <p>${p.name}</p>
        <small>SKU: ${p.sku || "N/A"}</small>
      </div>
      <div class="units">${p.stock} units left</div>
    `;
    scrollable.appendChild(div);
  });

  if (!lowStockProducts.length) {
    const div = document.createElement("div");
    div.classList.add("no-low-stock"); // new class
    div.innerHTML = `
      <p>All stocks are sufficient ðŸŽ‰</p>
    `;
    scrollable.appendChild(div);
  }
}







// ðŸŽ¨ Custom Colors
const customColors = ["#E8F1FF", "#A3BADA", "#164285"];

// ðŸ¥§ Pie Chart
function renderCategoryChart(products) {
  const ctx = document.getElementById("categoryChart");
  if (!ctx) return [];

  const categoryTotals = {};
  products.forEach(p => {
    const category = p.category || "Uncategorized";
    categoryTotals[category] = (categoryTotals[category] || 0) + (p.stock || 0);
  });

  const labels = Object.keys(categoryTotals);
  const data = Object.values(categoryTotals);
  const colors = labels.map((_, i) => customColors[i % customColors.length]);

  if (categoryChart) categoryChart.destroy();

  categoryChart = new Chart(ctx, {
    type: "pie",
    data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: "#fff", borderWidth: 2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom", labels: { color: "#333", font: { size: 14 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.formattedValue} units` } }
      }
    }
  });

  return labels;
}

// ðŸ“ˆ Line Chart (Stock Trend)
function renderStockTrendChart(products, categories) {
  const ctx = document.getElementById("stockTrendChart");
  if (!ctx) return;

  const monthlyData = {};
  categories.forEach(cat => monthlyData[cat] = {});

  products.forEach(p => {
    const category = p.category || "Uncategorized";
    const updatedAt = new Date(p.updatedAt || p.createdAt || Date.now());
    const monthKey = updatedAt.toLocaleString('default', { month: 'short' });
    monthlyData[category][monthKey] = (monthlyData[category][monthKey] || 0) + (p.stock || 0);
  });

  const allMonths = Array.from(new Set(Object.values(monthlyData).flatMap(obj => Object.keys(obj))))
                        .sort((a,b) => new Date(`2024 ${a} 1`) - new Date(`2024 ${b} 1`));

  const datasets = categories.map((cat, i) => ({
    label: cat,
    data: allMonths.map(month => monthlyData[cat][month] || 0),
    borderWidth: 3,
    borderColor: customColors[i % customColors.length],
    backgroundColor: "transparent",
    fill: false,
    tension: 0.3,
    pointRadius: 5,
    pointHoverRadius: 7,
    pointBackgroundColor: "#fff",
    pointBorderColor: "#333",
    pointBorderWidth: 2
  }));

  if (stockTrendChart) stockTrendChart.destroy();

  stockTrendChart = new Chart(ctx, {
    type: "line",
    data: { labels: allMonths, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 0 },
      plugins: {
        legend: { position: "bottom", labels: { color: "#333", font: { size: 13 } } },
        tooltip: { mode: "nearest", intersect: false, callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue} units` } }
      },
      scales: {
        x: { grid: { color: "rgba(0,0,0,0.05)" }, ticks: { color: "#333", padding: 14 } },
        y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.1)" }, ticks: { color: "#333", padding: 10 } }
      }
    }
  });
}

// ðŸ” Filter â€” table uses search+category, alerts only category
function filterProducts() {
  const searchInput = document.querySelector(".search-box input").value.toLowerCase();
  const selectedCategory = document.querySelector("select").value;

  // Table filtered by search + category
  const filteredTable = allProducts.filter(p =>
    (p.name.toLowerCase().includes(searchInput) || (p.sku && p.sku.toLowerCase().includes(searchInput))) &&
    (selectedCategory === "All Categories" || p.category === selectedCategory)
  );
  displayProducts(filteredTable);


  displayLowStock(filteredTable);
}

// âš™ï¸ Initialize
document.addEventListener("DOMContentLoaded", () => {
  loadProducts();
  document.querySelector(".search-box input").addEventListener("input", filterProducts);
  document.querySelector("select").addEventListener("change", filterProducts);
});




// ================================
// ðŸ§© Add / Update Stock Modal Logic
// ================================
const addBtn = document.querySelector(".add-btn");
const modal = document.getElementById("addProductModal");
const closeBtn = modal.querySelector(".close");
const form = document.getElementById("addProductForm");
const searchInput = document.getElementById("searchProduct");
const resultsList = document.getElementById("searchResults");

let selectedProduct = null;

// Open modal
addBtn.addEventListener("click", () => {
  modal.style.display = "flex";

  // Default tab â†’ Add / Update Stock
  document.getElementById("tab-update").click();

  // Clear both forms
  form.reset();
  newProductForm.reset();

  // Clear search results
  resultsList.innerHTML = "";
  selectedProduct = null;

  // Clear display fields
  document.getElementById("productName").value = "";
  document.getElementById("productSKU").value = "";
  document.getElementById("productCategory").value = "";
  document.getElementById("currentStock").value = "";

  // Update modal height properly
  setTimeout(updateModalHeight, 150);
});

// Close modal
closeBtn.addEventListener("click", () => {
  modal.style.display = "none";
});

// Close when clicking outside
window.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
});

// ðŸ” Search product in database
searchInput.addEventListener("input", async () => {
  const query = searchInput.value.trim().toLowerCase();
  resultsList.innerHTML = "";
  if (query.length < 2) return;

  try {
    const res = await fetch(`/products`);
    const products = await res.json();

    const matches = products.filter(p =>
      p.name.toLowerCase().includes(query)
    );

    if (matches.length === 0) {
      resultsList.innerHTML = "<li>No products found</li>";
      return;
    }

    matches.forEach(p => {
      const li = document.createElement("li");
      li.textContent = `${p.name} (${p.sku || "N/A"})`;
      li.addEventListener("click", () => selectProduct(p));
      resultsList.appendChild(li);
    });
  } catch (err) {
    console.error("Search error:", err);
  }
});

// âœ… When clicking an item in search results
function selectProduct(p) {
  selectedProduct = p;
  document.getElementById("productName").value = p.name;
  document.getElementById("productSKU").value = p.sku || "N/A";
  document.getElementById("productCategory").value = p.category || "Uncategorized";
  document.getElementById("currentStock").value = p.stock ?? 0;

  resultsList.innerHTML = "";
  searchInput.value = p.name;
}

// ðŸ’¾ Add stock to selected product
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!selectedProduct) {
    showStatusMessage("Please select a product first.", true);
    return;
  }

  const addAmount = parseInt(document.getElementById("addStockAmount").value);
  if (isNaN(addAmount) || addAmount <= 0) {
     showStatusMessage("Enter a valid stock quantity to add.", true);
    return;
  }

  const newStock = (selectedProduct.stock || 0) + addAmount;

  try {
    const res = await fetch(`/products/${selectedProduct._id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stock: newStock }),
    });

    if (res.ok) {
     showStatusMessage(`Added ${addAmount} stock to ${selectedProduct.name}`);
      modal.style.display = "none";
      loadProducts();
    } else {
       showStatusMessage("Failed to update stock.", true);
    }
  } catch (err) {
    console.error(err);
   showStatusMessage("Error connecting to server.", true);
  }
});

// ðŸ§© Modal tab switching with auto-clear inactive form
const modalSectionsWrapper = document.querySelector(".modal-sections-wrapper");
const tabs = document.querySelectorAll(".modal-tabs button");
const sections = document.querySelectorAll(".modal-section");






// ðŸª„ Simpler Tab Switching (no height animation)
tabs.forEach(btn => {
  btn.addEventListener("click", () => {
    // switch active tab
    tabs.forEach(t => t.classList.remove("active"));
    btn.classList.add("active");

    // switch visible form
    const targetId = btn.dataset.target;
    sections.forEach(sec => sec.classList.toggle("active", sec.id === targetId));

    // keep modal size fixed (remove height animation)
    modalSectionsWrapper.style.height = "auto";
  });
});


// ðŸŽ¯ Initialize height when modal opens
function openModal() {
  modal.style.display = "flex";
  setTimeout(updateModalHeight, 100);
}

// ðŸ§¹ Close modal
function closeModal() {
  modal.style.display = "none";
}

// Example open button trigger (if you have one)
document.querySelectorAll("[data-open='addProductModal']").forEach(btn => {
  btn.addEventListener("click", openModal);
});

// Close when clicking X
modal.querySelector(".close").addEventListener("click", closeModal);

// ðŸªŸ Adjust dynamically on resize
window.addEventListener("resize", updateModalHeight);


// ==========================
// ðŸ§© Handle Add New Product (Clean Version)
// ==========================
const newProductForm = document.getElementById("newProductForm");

newProductForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Collect form values
  const name = document.getElementById("newProductName").value.trim();
  const category = document.getElementById("newProductCategory").value;
  const stock = parseInt(document.getElementById("newProductStock").value);
  const price = parseFloat(document.getElementById("newProductPrice").value);

  // Validate
 if (!name) return showStatusMessage("Product name is required.", true);
  if (isNaN(stock) || stock < 0) return showStatusMessage("Please enter a valid initial stock quantity.", true);
  if (isNaN(price) || price < 0) return showStatusMessage("Please enter a valid price.", true);
  if (!category) return showStatusMessage("Please select a category.", true);

  try {
    // Send to backend
    const res = await fetch("/products", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, category, stock, price }),
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.message || "Failed to add product.");
    }

    // Success
    const newProduct = await res.json();
 showStatusMessage(`Product "${newProduct.name}" added successfully!`);


    // Refresh list
    await loadProducts();

    // Reset and close modal
    newProductForm.reset();
    modal.style.display = "none";

    // Switch back to Add / Update Stock tab
    document.getElementById("tab-update").click();

  } catch (err) {
    console.error("Add product error:", err);
    showStatusMessage(err.message, true);

  }
});

// ===============================
// ðŸ§© Role-based UI visibility (case-insensitive)
// ===============================
let userRole = "";

try {
  const userData = JSON.parse(localStorage.getItem("user"));
  userRole = (userData?.role || "").toLowerCase().trim();
} catch (err) {
  console.warn("No valid user data found in localStorage:", err);
}

const addProductButton = document.querySelector(".add-btn");

if (addProductButton) {
  if (userRole === "admin" || userRole === "manager") {
    addProductButton.style.display = "inline-flex";
  } else {
    addProductButton.style.display = "none";
  }
}


function showStatusMessage(message, isError = false) {
  const status = document.getElementById('saveStatus');
  status.textContent = message;
  status.classList.add('show');
  status.classList.toggle('error', isError);

  // Auto-hide after 2.5 seconds
  setTimeout(() => {
    status.classList.remove('show', 'error');
  }, 2500);
}

</script>



</body>
</html>
