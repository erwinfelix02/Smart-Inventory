<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="inventory-management.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</head>
<body>

  <div class="dashboard-container">
    
    <!-- ===== Inventory Overview ===== -->
    <section class="overview">
      <h2>Inventory Overview</h2>
      <div class="overview-cards">
        <div class="overview-card total">
         <div class="icon">
         <img src="../images/total.svg" alt="Box Icon"></div>
          <div class="info">
            <h3>Total Products</h3>
            <p>1,247</p>
          </div>
        </div>

        <div class="overview-card in-stock">
          <div class="icon">
         <img src="../images/check.svg" alt="Check Icon"></div>
          <div class="info">
            <h3>In Stock</h3>
            <p>1,089</p>
          </div>
        </div>

        <div class="overview-card low-stock">
          <div class="icon">
         <img src="../images/warning.svg" alt="Warn Icon"></div>
          <div class="info">
            <h3>Low Stock</h3>
            <p>142</p>
          </div>
        </div>

        <div class="overview-card out-stock">
        <div class="icon">
         <img src="../images/wrong.svg" alt="Wrong Icon"></div>
          <div class="info">
            <h3>Out of Stock</h3>
            <p>1,089</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Product Inventory + Alerts (Side by Side) ===== -->
    <section class="main-content">
      
      <!-- Product Inventory -->
      <div class="product-inventory">
        <div class="inventory-header">
          <h3>Product Inventory</h3>
          <div class="filters">
            <div class="search-box">
              <i class="fa fa-search"></i>
              <input type="text" placeholder="Search products..." />
            </div>
            <select>
              <option>All Categories</option>
              <option>Electronics</option>
              <option>Accessories</option>
              <option>Cables</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Product Name</th>
        <th>SKU</th>
        <th>Category</th>
        <th>Current Quantity</th>
        <th>Stock Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- dynamically loaded rows -->
    </tbody>
  </table>
</div>
      </div>
      
<!-- Low Stock Alerts -->
<div class="low-stock-alerts">
  <h3>Low Stock Alerts</h3>
  <div class="alert-scrollable">
    <!-- JS will insert .alert-item here -->
  </div>
</div>


    </section>

    <!-- ===== Charts Section ===== -->
    <section class="charts">
      <div class="chart-card">
        <h3>Stock Distribution by Category</h3>
       <div class="chart-placeholder">
          <canvas id="categoryChart"></canvas>
       </div>
      </div>

      <div class="chart-card">
        <h3>Stock Levels Trend</h3>
      <div class="chart-placeholder">
        <canvas id="stockTrendChart"></canvas>
      </div>
      </div>

    </section>
  </div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allProducts = [];
let categoryChart;
let stockTrendChart;

// üß© Load all products once
async function loadProducts() {
  try {
    const res = await fetch("/products");
    const products = await res.json();
    allProducts = products;

    updateDashboard(products);
    displayProducts(products);
    displayLowStock(products); // initial low stock alerts
    const categories = renderCategoryChart(products);
    renderStockTrendChart(products, categories);
  } catch (err) {
    console.error("Error loading products:", err);
  }
}

// üìä Dashboard Counters
function updateDashboard(products) {
  const totalQuantity = products.reduce((sum, p) => sum + (p.stock || 0), 0);
  const inStock = products.filter(p => p.stock > 10).length;
  const lowStock = products.filter(p => p.stock > 0 && p.stock <= 10).length;
  const outStock = products.filter(p => p.stock === 0).length;

  document.querySelector(".total p").textContent = totalQuantity;
  document.querySelector(".in-stock p").textContent = inStock;
  document.querySelector(".low-stock p").textContent = lowStock;
  document.querySelector(".out-stock p").textContent = outStock;
}

// üìã Product Table
function displayProducts(products) {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  if (!products.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No products found</td></tr>`;
    return;
  }

  products.forEach(p => {
    const tr = document.createElement("tr");
    let statusClass = "", statusText = "";

    if (p.stock === 0) { statusClass = "out"; statusText = "Out of Stock"; }
    else if (p.stock <= 10) { statusClass = "low"; statusText = "Low Stock"; }
    else { statusClass = "normal"; statusText = "Normal"; }

    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.sku || "-"}</td>
      <td>${p.category || "Uncategorized"}</td>
      <td>${p.stock}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// üö® Low Stock Alerts ‚Äî only respect category filter
function displayLowStock(products) {
  const scrollable = document.querySelector(".low-stock-alerts .alert-scrollable");
  scrollable.innerHTML = ""; // clear only the scrollable area

  const lowProducts = products.filter(p => p.stock > 0 && p.stock <= 10);

  if (!lowProducts.length) {
    scrollable.innerHTML = `<p style="text-align:center;">All stocks are sufficient üéâ</p>`;
    return;
  }

  lowProducts.forEach(p => {
    const div = document.createElement("div");
    div.classList.add("alert-item");
    div.innerHTML = `
      <img src="../images/exclamation.svg" class="alert-icon" alt="alert">
      <div class="details">
        <p>${p.name}</p>
        <small>SKU: ${p.sku || "N/A"}</small>
      </div>
      <div class="units">${p.stock} units left</div>
    `;
    scrollable.appendChild(div);
  });
}


// üé® Custom Colors
const customColors = ["#E8F1FF", "#A3BADA", "#164285"];

// ü•ß Pie Chart
function renderCategoryChart(products) {
  const ctx = document.getElementById("categoryChart");
  if (!ctx) return [];

  const categoryTotals = {};
  products.forEach(p => {
    const category = p.category || "Uncategorized";
    categoryTotals[category] = (categoryTotals[category] || 0) + (p.stock || 0);
  });

  const labels = Object.keys(categoryTotals);
  const data = Object.values(categoryTotals);
  const colors = labels.map((_, i) => customColors[i % customColors.length]);

  if (categoryChart) categoryChart.destroy();

  categoryChart = new Chart(ctx, {
    type: "pie",
    data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: "#fff", borderWidth: 2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom", labels: { color: "#333", font: { size: 14 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.formattedValue} units` } }
      }
    }
  });

  return labels;
}

// üìà Line Chart (Stock Trend)
function renderStockTrendChart(products, categories) {
  const ctx = document.getElementById("stockTrendChart");
  if (!ctx) return;

  const monthlyData = {};
  categories.forEach(cat => monthlyData[cat] = {});

  products.forEach(p => {
    const category = p.category || "Uncategorized";
    const updatedAt = new Date(p.updatedAt || p.createdAt || Date.now());
    const monthKey = updatedAt.toLocaleString('default', { month: 'short' });
    monthlyData[category][monthKey] = (monthlyData[category][monthKey] || 0) + (p.stock || 0);
  });

  const allMonths = Array.from(new Set(Object.values(monthlyData).flatMap(obj => Object.keys(obj))))
                        .sort((a,b) => new Date(`2024 ${a} 1`) - new Date(`2024 ${b} 1`));

  const datasets = categories.map((cat, i) => ({
    label: cat,
    data: allMonths.map(month => monthlyData[cat][month] || 0),
    borderWidth: 3,
    borderColor: customColors[i % customColors.length],
    backgroundColor: "transparent",
    fill: false,
    tension: 0.3,
    pointRadius: 5,
    pointHoverRadius: 7,
    pointBackgroundColor: "#fff",
    pointBorderColor: "#333",
    pointBorderWidth: 2
  }));

  if (stockTrendChart) stockTrendChart.destroy();

  stockTrendChart = new Chart(ctx, {
    type: "line",
    data: { labels: allMonths, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 0 },
      plugins: {
        legend: { position: "bottom", labels: { color: "#333", font: { size: 13 } } },
        tooltip: { mode: "nearest", intersect: false, callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue} units` } }
      },
      scales: {
        x: { grid: { color: "rgba(0,0,0,0.05)" }, ticks: { color: "#333", padding: 14 } },
        y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.1)" }, ticks: { color: "#333", padding: 10 } }
      }
    }
  });
}

// üîç Filter ‚Äî table uses search+category, alerts only category
function filterProducts() {
  const searchInput = document.querySelector(".search-box input").value.toLowerCase();
  const selectedCategory = document.querySelector("select").value;

  // Table filtered by search + category
  const filteredTable = allProducts.filter(p =>
    (p.name.toLowerCase().includes(searchInput) || (p.sku && p.sku.toLowerCase().includes(searchInput))) &&
    (selectedCategory === "All Categories" || p.category === selectedCategory)
  );
  displayProducts(filteredTable);


  displayLowStock(filteredAlerts);
}

// ‚öôÔ∏è Initialize
document.addEventListener("DOMContentLoaded", () => {
  loadProducts();
  document.querySelector(".search-box input").addEventListener("input", filterProducts);
  document.querySelector("select").addEventListener("change", filterProducts);
});
</script>



</body>
</html>
